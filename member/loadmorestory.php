<?phprequire "../connect_db.php";require "../include/functions.php";require "../include/user_auth_fns.php";session_start();$from = $_POST['from'];$first_item = intval($_POST['first_item']);$sort = $_POST['sort'];$limit = 16;$content = "";switch($from){  case "sub":{    $login_flag = islogin();	if(!$login_flag)	{	  exit;	}	$user_id = $_SESSION['uid'];	$query="select COUNT(*) as num from ".$db_prefix."follow, story_posts where user_id=".$user_id." and follow_id = post_author and post_status = 'Published'";	if(0 == strcmp($sort, 'time'))	{	  $sort_type = "post_modified";	}	else	{	  $sort_type = "popular_count";	}	$sql = "select story_posts.* from ".$db_prefix."follow, story_posts where user_id=".$user_id." and follow_id = post_author and post_status = 'Published' order by ".$sort_type." desc LIMIT $first_item, $limit";    $total = mysql_fetch_array(mysql_query($query));	$total = $total[num];	break;  }  case "all":{	if(0 == strcmp($sort, 'time'))	{	  $sort_type = "post_modified";	}	else	{	  $sort_type = "popular_count";	}	$sql = "select story_posts.* from story_posts where post_status = 'Published' order by ".$sort_type." desc LIMIT $first_item, $limit";	$query = "select COUNT(*) as num from story_posts where post_status = 'Published'";	$total = mysql_fetch_array(mysql_query($query));	$total = $total[num];    break;  }  case "user":{    $user_flag = true;    $limit = 9;	$user_id = intval($_POST['uid']);	$category = $_POST['category'];    $login_flag = islogin();	if($login_flag && $user_id == $_SESSION['uid'])	{	  $self_flag = true;	  $extra_limit = " and post_status = 'Published'";	}	else	{	  $self_flag = false;	  $extra_limit = "";	}	if(0 == strcmp($category, 'like'))	{	  $like_flag = true;	  $query="SELECT postid_str FROM story_favor WHERE user_id=".$user_id;	  $result=$DB->query($query);	  if($DB->num_rows($result)== 1)	  {	    $row=$DB->fetch_array($result);         $tmp_array=explode(":",$row['postid_str']);        $total = count($tmp_array);		$tmp_array = array_reverse($tmp_array);		$tmp_array = array_slice($tmp_array,$first_item,$limit);		$like_ids = join(',',$tmp_array);		$sql = "SELECT * FROM story_posts WHERE ID IN ($like_ids) ORDER BY FIND_IN_SET(ID, '$like_ids')";	  }	}	else	{	  $query = "SELECT COUNT(*) as num FROM story_posts where post_author='.$user_id.'".$extra_limit;      $total = mysql_fetch_array(mysql_query($query));      $total = $total[num];	  $sql = "SELECT * FROM story_posts where post_author='.$user_id.'".$extra_limit." order by post_modified desc LIMIT $first_item, $limit";	}    break;  }  default:    break;}$result=$DB->query($sql);if($user_flag){  if($like_flag)  {    if($self_flag)	{	  $content .= printLikedStory($result,$_SESSION['uid']);	}	else	{	  $content .= printLikedStory($result,0);	}  }  else  {    while ($story_item = mysql_fetch_array($result))	{		$sview_count = 0;		$post_id = $story_item['ID'];		$post_title = $story_item['post_title'];		$post_pic_url = $story_item['post_pic_url'];		if($post_pic_url == '')		{	      $post_pic_url = '/img/event_dft.jpg';		}		$post_status = $story_item['post_status'];		if(0 == strcmp($post_status, 'Published'))		{		  $post_status_txt = '已发布';		  $icon_type = 'publish_icon';		}		else		{		  $post_status_txt = '草稿';		  $icon_type = 'draft_icon';		}				$userresult = $DB->fetch_one_array("SELECT username, photo FROM ".$db_prefix."user where id='".$user_id."'");	    $user_profile_img = $userresult['photo'];	    $username = $userresult['username'];	    if($user_profile_img == '')	    {		  $user_profile_img = '/img/douban_user_dft.jpg';	    }				$post_date = dateFormatTrans($story_item['post_date'],date("Y-m-d H:i:s"));		$post_link = "/user/".$user_id."/".$post_id;		$post_link = htmlspecialchars($post_link);				$count_query = "select domain_name, refer_url, view_count from ".$db_prefix."pageview where story_id=".$post_id;		$countResult = $DB->query($count_query);		if($DB->num_rows($countResult) > 0){			while($count_result_row = $DB->fetch_array($countResult)){				$sview_count += $count_result_row['view_count'];			}		}		$content .="<li>							<div class='story_wrap'>							  <a href='".$post_link."'>								<img class='cover' src='".$post_pic_url."' alt='' />							  </a>							  <a class='title_wrap' href='".$post_link."'>								<span class='title'>".$post_title."</span>							  </a>";		if($self_flag)		{		  $content .="<div class='editable'>		  <div class='actions'>			<a id='delete_".$user_id."_".$post_id."' class='icon delete png_fix' title='删除' href='#'></a>			<a class='icon edit png_fix' title='编辑' href='/user/".$user_id."/".$post_id."/edit'></a>		  </div>		  <div class='status'>			<div class='".$post_status."'>			  <div class='".$icon_type." png_fix'></div>			  <span>".$post_status_txt."</span>			</div>		  </div>		  <div class='clear'></div>		  </div>";		}		$content .="</div>					<div class='story_meta'>					  <div class='float_l'>					    <img src='".$user_profile_img."' alt='' />					  </div>					  <div class='meta_info'>					    <div>						  <a class='meta_author'>".$username."</a>						  <div class='meta_date'>".$post_date."</div>						  <div class='meta_view'>".$sview_count."</div>					    </div>					  </div>					  <div class='clear'></div>				    </div>				  </li>";	}  }}else{  $content .= printStory($result);}if(($total-$first_item) > $limit){  $next_item_id = $first_item + $limit;  if($user_flag)  {    $content .="<div class='more_content'><a id='user_".$next_item_id."_".$user_id."' class='load_more' href='#'>更多</a></div>";  }  else  {    $content .="<div class='more_content'><a id='sub_".$next_item_id."' class='load_more' href='#'>更多</a></div>";  }}echo $content;?>