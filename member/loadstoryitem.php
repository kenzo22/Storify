<?phpinclude "../connect_db.php";include "../include/functions.php";session_start();include_once( '../weibo/config.php' );include_once( '../weibo/sinaweibo.php' );include_once( '../tweibo/config.php' );include_once( '../tweibo/txwboauth.php' );$c = new WeiboClient( WB_AKEY , WB_SKEY , $_SESSION['last_key']['oauth_token'] , $_SESSION['last_key']['oauth_token_secret']  );$t = new TWeiboClient( MB_AKEY , MB_SKEY , $_SESSION['last_tkey']['oauth_token'] , $_SESSION['last_tkey']['oauth_token_secret']  );$post_id = $_POST['post_id'];$first_item = intval($_POST['first_item']);$result = $DB->fetch_one_array("select * from ".$db_prefix."posts where ID='".$post_id."'");if(!$result){  throw new Exception('Could not execute query.');}$story_content=$result['post_content'];$temp_array = json_decode($story_content, true);$story_content_array = array_slice($temp_array['content'], $first_item, 8, true);$content = '';foreach($story_content_array as $key=>$val){  if($val['type'] === 'weibo')  {	$weibo_per_id = $val['content'];	$single_weibo  = $c->show_status($weibo_per_id );		if ($single_weibo === false || $single_weibo === null){	echo "Error occured";	return false;	}	if (isset($single_weibo['error_code']) && isset($single_weibo['error'])){		echo ('Error_code: '.$single_weibo['error_code'].';  Error: '.$single_weibo['error'] );		return false;	}	if (isset($single_weibo['id']) && isset($single_weibo['text'])){		$createTime = dateFormat($single_weibo['created_at']);				$content .="<li class='weibo_drop sina' id='$weibo_per_id' style='border:none;'><div class='story_wrapper'><div><span class='weibo_text'>".$single_weibo['text']."</span></div>		<div id='story_signature'><span style='float:right;'><a href='http://weibo.com/".$single_weibo['user']['id']."' target='_blank'><img class='profile_img' style='width: 32px; height: 32px; overflow: hidden; margin-top:2px;' src='"		.$single_weibo['user']['profile_image_url']."' alt='".$single_weibo['user']['screen_name']."' border=0 /></a></span><span id='signature_text' style=' margin-right:5px; float:right;' ><div style='text-align:right; height:16px;'>		<span ><a class='weibo_from' href='http://weibo.com/".$single_weibo['user']['id']."' target='_blank'>".$single_weibo['user']['screen_name']."</a></span></div><div class='weibo_date'  style='text-align:right; height:16px;'><span>		<img border='0' style='position:relative; top:2px' src='/Storify/img/sina16.png'/><a>".$createTime."</a></span></div></span> </div></div></li>";	}  }  else if($val['type'] === 'tweibo')  {	$tweibo_per_id = $val['content'];	//$single_tweibo  = $c->show_status($weibo_per_id );	$single_tweibo = $t->t_show($tweibo_per_id);	if($single_tweibo['ret'] != 0 || $single_tweibo['errcode'] != 0)	{	  echo ('Error_code: '.$single_tweibo['errcode'].';  Ret: '.$single_tweibo['ret'] );	  return false;	}	else	{	  $tweiboData = $single_tweibo[data];	  $time = getdate($tweiboData['timestamp']);	  $create_time = $time[year]."-".$time[mon]."-".$time[mday]." ".$time[hours].":".$time[minutes];	  $profileImgUrl = $tweiboData['head']."/50";			  $content .="<li class='weibo_drop tencent' id='$tweibo_per_id' style='border:none;'><div class='story_wrapper'><div><span class='weibo_text'>".$tweiboData['text']."</span></div>		<div id='story_signature'><span style='float:right;'><a href='http://t.qq.com/".$tweiboData['name']."' target='_blank'><img class='profile_img' style='width: 32px; height: 32px; overflow: hidden; margin-top:2px;' src='"		.$profileImgUrl."' alt='".$tweiboData['nick']."' border=0 /></a></span><span id='signature_text' style=' margin-right:5px; float:right;' ><div style='text-align:right; height:16px;'>		<span ><a class='weibo_from' href='http://t.qq.com/".$tweiboData['name']."' target='_blank'>".$tweiboData['nick']."</a></span></div><div class='weibo_date'  style='text-align:right; height:16px;'><span>		<img border='0' style='position:relative; top:2px' src='/Storify/img/tencent16.png'/><a>".$create_time."</a></span></div></span> </div></div></li>";	}  }  else if($val['type'] === 'comment')  {	$comment_text = $val['content'];	$content .="<li class='textElement'><div class='commentBox'>".$comment_text."</div></li>";	  }  else if($val['type'] === 'video')  {	$video_url = $val['content'];	$content .="<li class='video_element'><div><a class='videoTitle' target='_blank' href='".$video_url."'></a></div></li>";	  }  else if($val['type'] === 'photo')  {	$photo_meta_data = $val['content'];	$photo_title = $photo_meta_data['title'];	$photo_author = $photo_meta_data['author'];	$photo_per_url = $photo_meta_data['url'];	$content .="<li class='photo_element'><div style='margin:0px auto; text-align:center; border: 5px solid #FFFFFF; box-shadow: 0 0 10px rgba(0, 0, 0, 0.4); max-width: 260px;'><img src='"			.$photo_per_url."'/><div class='pic_title' style='line-height:1.5;'>".$photo_title."</div><div class='pic_author' style='line-height:1.5;'>".$photo_author."</div></div></li>";	  }}echo $content;?>