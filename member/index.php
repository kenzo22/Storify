<?phpinclude "../global.php";?><link type="text/css" href="/storify/css/jquery.ui.theme.css" rel="stylesheet" /><link type="text/css" href="/storify/css/jquery.ui.tabs.css" rel="stylesheet" /><link type="text/css" rel="stylesheet" href="http://js.wcdn.cn/t3/style/css/common/card.css" /><link rel="stylesheet" type="text/css" href="/storify/CLEditor/jquery.cleditor.css" /><script type="text/javascript" src="/storify/CLEditor/jquery.cleditor.min.js"></script><script type="text/javascript" src="/storify/js/jquery.embedly.min.js"></script><script type='text/javascript' src='http://js.wcdn.cn/t3/platform/js/api/wb.js'></script><script type='text/javascript' src='/storify/js/weibo.js'></script><script type='text/javascript' src='/storify/js/jquery-ui-1.8.12.custom.min.js'></script><script>function display_search(){  $('.weibo_drag').remove();  $('#keywords').val('');  $('#weibo_search button').text('搜索微博');  $('#weibo_search').css('display', 'block');}function display_user_search(){  $('.weibo_drag').remove();  $('#keywords').val('');  $('#weibo_search button').text('搜索用户');  $('#weibo_search').css('display', 'block');}function get_weibo_by_id(ID){  WB.client.parseCMD('/statuses/show/#{id}.json', function(sResult, bStatus)  {	var weiboText, from, from_id, created_time, photo;	weiboText= sResult.text;	created_time = sResult.created_at;	created_time = date_format(created_time);  	from = sResult.user.screen_name;	from_id = sResult.user.id;	photo = sResult.user.profile_image_url;	var content = ("<div class='story_wrapper'><div><span class='weibo_text'>"+weiboText+"</span></div><div id='story_signature'><div style='float:right;'><a href='http://weibo.com/"+from_id+"' target='_blank'><img class='profile_img' style='width: 32px; height: 32px; overflow: hidden; margin-top:2px;' src='"+photo+"' alt='"+from+"' border=0 /></a></div><div id='signature_text' style='float:right; margin-right:5px;'><a class='weibo_from' href='http://weibo.com/"+from_id+"' target='_blank' style='display:block; height:16px;'><span>"+from+"</span></a><span class='weibo_date' style='display:block; height:16px;'>"+created_time+"</span></div></div></div>");	$("#" + ID).append(content).css({'padding':'0px 5px 5px 5px', 'border-color':'#ababac', 'border-style':'solid', 'border-width':'2px', 'border-radius':'5px', '-moz-border-radius':'5px', '-webkit-border-radius':'5px',			  'margin':'auto', 'width':'90%', 'margin-top':'5px', 'overflow':'auto'});	},	{	  id : ID	},	{	  method: 'get'	});}function get_weibo_by_id2(id_array){  var weiboText, from, from_id, created_time, photo;  var div_content = new Array();  var j=0;  for (var i in id_array)  {	WB.client.parseCMD('/statuses/show/#{id}.json', function(sResult, bStatus)    {	  weiboText= sResult.text;	  created_time = sResult.created_at;	  created_time = date_format(created_time);  	  from = sResult.user.screen_name;	  from_id = sResult.user.id;	  photo = sResult.user.profile_image_url;	  var $div_content = $("<li class='weibo_drop' id='"+id_array[j]+"'><div class='cross' action='delete' style='visibility:hidden; padding-left:355px;'><a><img src='/Storify/img/cross.png' border='0' onclick='remove_item(event)'/></a></div><div class='story_wrapper'><div><span class='weibo_text_drop'>"+weiboText+"</span></div><div id='story_signature'><div style='float:right;'><a href='http://weibo.com/"+from_id+"' target='_blank'><img class='profile_img_drop' style='width: 32px; height: 32px; overflow: hidden; margin-top:2px;' src='"+photo+"' alt='"+from+"' border=0 /></a></div><div id='signature_text' style='float:right; margin-right:5px;'><a class='weibo_from_drop' href='http://weibo.com/"+from_id+"' target='_blank' style='display:block; height:16px;'><span>"+from+"</span></a><span class='weibo_date_drop' style='display:block; height:16px;'>"+created_time+"</span></div></div></div></li>");	  $('#story_list').append($div_content);	  j++;	},	{	  id : id_array[i]	},	{	  method: 'get'	});  }}function append_content(id_array, content_array){  for (var i in id_array)  {	var $contentToAppend = $(content_array[i]);	$("#" + id_array[i]).append($contentToAppend);  }}function replaceURLWithHTMLLinks(source) {	var exp = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;    replaced = source.replace(exp,"<a href='$1' target='_blank'>$1</a>"); 	return replaced;}$(function() {		$( '#weiboTabs' ).tabs();				$('#embedVideo').click(function(e)		{		  var embedCode, videoTitle;		  var videoUrl = $('#videoUrl').val();		  //var videoUrl = 'http://v.youku.com/v_show/id_XMjgxMjIxNjUy.html';		  $.embedly(videoUrl, {key: '4ac512dca79011e0aeec4040d3dc5c07', maxWidth: 420, wrapElement: 'div', method : "afterParent"  }, function(oembed){				          if (oembed != null)		  {			embedCode = oembed.code;			videoTitle = oembed.title;			var post = "<li class='video_Drag'><div class='urlWrapper'><div class='videoTitle'><a target='_blank' href='"+videoUrl+"'>"+oembed.title+			"</a></div><div class='videoContent'><div class='video_domain'><div class='video_favicon' style='display:inline;'><img src='/storify/img/youku.ico'/></div><div class='video_author' style='display:inline;'><a target='_blank' href='"			+videoUrl+"'>v.youku.com</a></div></div><img src='"+oembed.thumbnail_url+"' style='float:left;'/><div class='video_description' style='margin-left:133px;'>"+oembed.description+"</div></div></div></li>";			$('#source_list').prepend(post);						$('.video_Drag').draggable({			  cursor: 'move',			  revert:true,			  helper: 'original',			  opacity: 0.55,			  drag:function(e, ui)			  {			  }		    });						$('#story_pane').droppable({			  accept: '.video_Drag',			  activeClass: 'droppable-active',			  hoverClass: 'droppable-hover',			  drop: function(ev, ui) 			  {				ui.draggable.remove();				$('#story_list').append("<li class='video_drop'><div><a class='videoTitle' target='_blank' href='"+videoUrl+"'>"+videoTitle+"</a></div>"+embedCode+"</li><li class='addTextElementAnchor'><span><a><img class='add_comment' src='/Storify/img/editcomment.png' border='0'/></a></span></li>");			  }			});	  		  }		  			          });		})				if($('#sto_title').val() =='')		{		  $('#sto_title').val('写下你的故事标题吧(这将会是你故事的链接地址)').css('color', 'black').focus(function(){		  if($(this).val() == '写下你的故事标题吧(这将会是你故事的链接地址)')		  {		    $(this).val('').css('color', 'black');		  }		  }).blur(function(){		  if($(this).val() == '')		  {		    $(this).val('写下你的故事标题吧(这将会是你故事的链接地址)').css('color', 'black');		  }		  });		}						if($('#sto_summary').val() =='')		{		  $('#sto_summary').val('给你的故事写一个简短的描述').css('color', '#d8d8d8').focus(function(){		  if($(this).val() == '给你的故事写一个简短的描述')		  {		    $(this).val('').css('color', 'black');		  }		  		  }).blur(function(){		  if($(this).val() == '')		  {		    $(this).val('给你的故事写一个简短的描述').css('color', '#d8d8d8');		  }		  });		}						$('#story_list').hover(function(e){		if ($(e.target).is('.weibo_drop'))		{		  //$('.cross').css('visibility', 'hidden');		  $(e.target).children('.cross').css('visibility', 'visible');		}		},		function(ev)		{		  if ($(ev.target).is('.weibo_drop'))		  {		    //$('.cross').css('visibility', 'hidden');			$(ev.target).children('.cross').css('visibility', 'hidden');		  }		});						/*$('#story_list').mouseover(function(e)		{		  if ($(e.target).is('li'))		  {		    $(e.target).find('.cross').css('visibility', 'visible');		  }		});				$('#story_list').mouseout(function(e)		{		  if ($(e.target).is('li'))		  {		    $(e.target).find('.cross').css('visibility', 'hidden');		  }		});*/						$('#draftBtn').click(function(e){		  e.preventDefault();		  console.log('begin draft');		  var story_id_val;		  if (typeof(post_id)=="undefined" || post_id==null)		  {		    story_id_val = 0;		  }		  else		  {		    story_id_val = post_id;		  }		  		  var story_content_val = new Object;		  story_content_val.content = new Array();		  		  $('#story_list li:not(.addTextElementAnchor)').each(function(i)		  {		    if($(this).hasClass('weibo_drop'))			{			  story_content_val.content[i] = new Object;			  story_content_val.content[i].type = 'weibo';			  story_content_val.content[i].content = $(this).attr('id');			}			else if($(this).hasClass('textElement'))			{			  story_content_val.content[i] = new Object;			  story_content_val.content[i].type = 'comment';			  story_content_val.content[i].content = $(this).find('.commentBox').html();			}			else if($(this).hasClass('video_drop'))			{			  story_content_val.content[i] = new Object;			  story_content_val.content[i].type = 'video';			  story_content_val.content[i].content = $(this).find('.videoTitle').attr('href');			}		  });		  var story_content_val_string = JSON.stringify(story_content_val);		  		  var story_title_val = $('#sto_title').attr('value');		  var story_summary_val = $('#sto_summary').val();		  var postdata = {story_id: story_id_val, story_title: story_title_val, story_summary: story_summary_val, story_content: story_content_val_string};			  		  $.post('preview.php', postdata,		  function(data, textStatus)		  {            console.log(data);									self.location = data;		  });					});				$('#previewBtn').click(function(e){		  e.preventDefault();		  console.log('begin preview');		  var story_id_val;		  if (typeof(post_id)=="undefined" || post_id==null)		  {		    story_id_val = 0;		  }		  else		  {		    story_id_val = post_id;		  }		  		  var story_content_val = new Object;		  story_content_val.content = new Array();		  $('#story_list li:not(.addTextElementAnchor)').each(function(i)		  {		    if($(this).hasClass('weibo_drop'))			{			  story_content_val.content[i] = new Object;			  story_content_val.content[i].type = 'weibo';			  story_content_val.content[i].content = $(this).attr('id');			}			else if($(this).hasClass('textElement'))			{			  story_content_val.content[i] = new Object;			  story_content_val.content[i].type = 'comment';			  story_content_val.content[i].content = $(this).find('.commentBox').html();			}			else if($(this).hasClass('video_drop'))			{			  story_content_val.content[i] = new Object;			  story_content_val.content[i].type = 'video';			  story_content_val.content[i].content = $(this).find('.videoTitle').attr('href');			}		  });		  var story_content_val_string = JSON.stringify(story_content_val);		  		  var story_title_val = $('#sto_title').attr('value');		  var story_summary_val = $('#sto_summary').val();		  var postdata = {story_id: story_id_val, story_title: story_title_val, story_summary: story_summary_val, story_content: story_content_val_string};		  $.post('preview.php', postdata,		  function(data, textStatus)		  {            console.log(data);									self.location = data;		  });					});				$('#publishBtn').click(function(e)		{		  //console.log(post_id);		  e.preventDefault();		  console.log('begin publish');		  var story_id_val;		  if (typeof(post_id)=="undefined" || post_id==null)		  {		    story_id_val = 0;		  }		  else		  {		    story_id_val = post_id;		  }		  		  var story_content_val = new Object;		  story_content_val.content = new Array();		  /*$('.weibo_drop').each(function(i) 		  {			story_content_val.content[i] = new Object;			story_content_val.content[i].type = 'weibo';			story_content_val.content[i].content = $(this).attr('id');		  });		  var story_content_val_string = JSON.stringify(story_content_val);*/		  		  $('#story_list li:not(.addTextElementAnchor)').each(function(i)		  {		    //debugger;			if($(this).hasClass('weibo_drop'))			{			  story_content_val.content[i] = new Object;			  story_content_val.content[i].type = 'weibo';			  story_content_val.content[i].content = $(this).attr('id');			}			else if($(this).hasClass('textElement'))			{			  story_content_val.content[i] = new Object;			  story_content_val.content[i].type = 'comment';			  story_content_val.content[i].content = $(this).find('.commentBox').html();			}			else if($(this).hasClass('video_drop'))			{			  story_content_val.content[i] = new Object;			  story_content_val.content[i].type = 'video';			  story_content_val.content[i].content = $(this).find('.videoTitle').attr('href');			}		  });		  var story_content_val_string = JSON.stringify(story_content_val);		  		  var story_title_val = $('#sto_title').attr('value');		  var story_summary_val = $('#sto_summary').val();			  var postdata = {story_id: story_id_val, story_title: story_title_val, story_summary: story_summary_val, story_content: story_content_val_string};		  $.post('publish.php', postdata,		  function(data, textStatus)		  {            console.log(data);									self.location = data;					  });		});				$('#story_list').click(function(e)		{		  if ($(e.target).is('.add_comment'))		  {		    var $comment_box = $("<li class='textElement editing'><div class='editingDiv'><form class='formTextElement'><textarea class='inputEditor' name='input'></textarea></form><div class='belowTextEdit'><div class='actions' style='padding-left:255px;'><button class='cancel small cancelEditor' type='reset'>Cancel</button><button class='submit small blue submitComment' type='submit'>Done</button></div></div></div></li><li class='addTextElementAnchor'><span><a><img class='add_comment' src='/Storify/img/editcomment.png' border='0'/></a></span></li>");		    $(e.target).closest('li').after($comment_box);			$(".inputEditor").cleditor({			width:370,			height:200,			controls:"bold italic underline strikethrough link | font size",						});			//$(e.target).closest('#input').cleditor();		  }		  		  if($(e.target).is('.cancelEditor'))		  {			$(e.target).closest('.textElement').next('.addTextElementAnchor').remove();			$(e.target).closest('.textElement').remove();		  }		  		  if($(e.target).is('.submitComment'))		  {			//debugger;			var $textElement = $(e.target).closest('.textElement');			var comment = $textElement.find('.inputEditor').val();			$(e.target).closest('.editingDiv').remove();			var $commentDiv = $("<div class='commentBox'>"+comment+"</div>");			$textElement.removeClass('editing').addClass('editted').append($commentDiv);		  }		});								var $items = $('#vtab>ul>li');        $items.click(function() {        $items.removeClass('selected');        $(this).addClass('selected');        var index = $items.index($(this));        $('#vtab>div').hide().eq(index).show();		if(1 == index)		{		  $('.weibo_drag').remove();		}        }).eq(0).click();	  	});</script><?php$content = "<div class='div_center'><div id='actions' style='margin-left:20px;'><span><a id='draftBtn' href='./' >保存草稿</a></span><span style='margin-left:30px;'><a id='previewBtn' href='./' >预览</a></span><span style='margin-left:30px;'><a id='publishBtn' href='./' >发布</a></span></div><div class='content'>  <div class='inner'>	<div id='source_pane' class='float_l showborder'>	  <div id='source_controller'>	  </div>	  <div id='sourcelist_container'>	    <div id='vtab'>		  <ul>		    <li class='weiboLi'><a>微博</a></li>		    <li class='videoLi'><a>视频</a></li>		  </ul>		  <div id='weiboTabs'>		    <ul>		      <!--<li><a href='#tabs-1' onclick='run_api_cmd2()'>微博搜索</a></li>-->			  <li><a href='#tabs-1' onclick='display_search()'>微博搜索</a></li>		      <li><a href='#tabs-2' onclick='my_weibo()'>我的微博</a></li>		      <li><a href='#tabs-3' onclick='my_follow()'>我的关注</a></li>		      <li><a href='#tabs-4' onclick='display_user_search()'>用户搜索</a></li>	        </ul>		    <div id='tabs-1'> 		  	        </div> 	        <div id='tabs-2'> 		  	        </div> 	        <div id='tabs-3'> 		  	        </div> 	        <div id='tabs-4'> 		 	        </div> 			<div id='weibo_search' style='padding-left:10px;'>		      <form id='source_controller_form' action='#'>		        <p class='sep'>				  <label for='keywords'>关键字:</label><br />           			      <input style='width: 300px;' id='keywords' name='keywords' type='text'>			      <button type='button' value='search' onclick='weibo_search()'>搜索微博</button>                </p>			    <p></p>		      </form>		    </div>			  </div>		  <div id='videoTabs'>		    <form action='#'>		    <p>			  <label for='videoUrl'>视频地址:</label><br />           			  <input style='width: 300px;' id='videoUrl' name='videoUrl' type='text'>			  <button type='button' value='嵌入视频' id='embedVideo'>嵌入视频</button>            </p>		    </form>		  </div>		  		</div>    		<ul id='source_list' style='padding:0;'>		</ul>		  </div>	</div>	<div id='story_pane' class='float_l showborder'>	  <div id='story'>";if(isset($_GET['post_id'])){    $post_id = $_GET['post_id'];  echo "<script language=javascript >  var post_id=$post_id;  </script>";  $result = $DB->fetch_one_array("select * from ".$db_prefix."posts where ID='".$post_id."'");  if(!$result)  {	throw new Exception('Could not execute query.');  }  $story_title=$result['post_title'];  $story_summary=$result['post_summary'];  $story_content=$result['post_content'];  $story_content_array = json_decode($story_content, true);	  $content .="<div id='story_header'>		  <span > <input type='text' value='".$story_title."' name='story_title' id='sto_title' style='width:400px; margin:10px; font-weight:bold;'> </span>		  <div>		    <textarea id='sto_summary' style='width:400px; height:60px; margin:0px 10px;'>".$story_summary."</textarea>		  </div>		</div>		<div id='storylist_container'>		  <ul id='story_list' style='padding:0;'><li class='addTextElementAnchor'>			  <span><a><img class='add_comment' src='/Storify/img/editcomment.png' border='0'/></a></span></li>";    foreach($story_content_array['content'] as $key=>$val)  {		if($val['type'] === 'weibo')	{	  $weibo_per_id = $val['content'];	  $content .="<li class='weibo_drop' id='$weibo_per_id' style='border:none;'></li><li class='addTextElementAnchor'>			  <span><a><img class='add_comment' src='/Storify/img/editcomment.png' border='0'/></a></span></li>";	}	else if($val['type'] === 'comment')	{	  $comment_text = $val['content'];	  $content .="<li class='textElement editted'><div class='commentBox'>".$comment_text."</div></li><li class='addTextElementAnchor'>			  <span><a><img class='add_comment' src='/Storify/img/editcomment.png' border='0'/></a></span></li>";			}	else if($val['type'] === 'video')	{	  $video_url_php = $val['content'];	  $content .="<li class='video_drop'></li>";			}  }  $content .="</ul></div></div></div></div></div></div>";  echo $content;  echo "<script language='javascript' >			window.onload = function()			{			  $('.weibo_drop').each(function(){			  var weibo_permanent_id = $(this).attr('id');			  get_weibo_by_id(weibo_permanent_id);			  });			}			</script>";}else{  $content .= "<div id='story_header'>		  <span > <input type='text' value='' name='story_title' id='sto_title' style='width:400px; margin:10px; font-weight:bold;'> </span>		  <div>		    <textarea id='sto_summary' style='width:400px; height:60px; margin:0px 10px;'></textarea>		  </div>		</div>		<div id='storylist_container'>		  <div class='embedly'><a href='http://v.youku.com/v_show/id_XMjgyNTQxNzU2.html'>YouTube</a></div>		  <ul id='story_list' style='padding:0;'>		    <li class='addTextElementAnchor'>			  <span><a><img class='add_comment' src='/Storify/img/editcomment.png' border='0'/></a></span>		    </li>		  </ul>		</div>	  </div>	</div>  </div></div></div>";  echo $content;}include "../include/footer.htm";?>