<?phpinclude "../global.php";?><script type="text/javascript">  WB.core.load(['connect', 'client'], function()   {    var cfg = {              key: '314237338',			  xdpath: 'http://story.com/storify/html/xd.html'			};    WB.connect.init(cfg);    WB.client.init(cfg);  });function get_weibo_by_id(ID){  WB.client.parseCMD('/statuses/show/#{id}.json', function(sResult, bStatus)  {	var weiboText, from, from_id, created_time, photo;	weiboText= sResult.text;	created_time = sResult.created_at;	created_time = date_format(created_time);  	from = sResult.user.screen_name;	from_id = sResult.user.id;	photo = sResult.user.profile_image_url;	var content = ("<div class='story_wrapper'><div><span class='weibo_text'>"+weiboText+"</span></div><div id='story_signature'><div style='float:right;'><a href='http://weibo.com/"+from_id+"' target='_blank'><img class='profile_img' style='width: 32px; height: 32px; overflow: hidden; margin-top:2px;' src='"+photo+"' alt='"+from+"' border=0 /></a></div><div id='signature_text' style='float:right; margin-right:5px;'><a class='weibo_from' href='http://weibo.com/"+from_id+"' target='_blank' style='display:block; height:16px;'><span>"+from+"</span></a><span class='weibo_date' style='display:block; height:16px;'>"+created_time+"</span></div></div></div>");	$("#" + ID).append(content);	},	{	  id : ID	},	{	  method: 'get'	});}function get_weibo_by_id2(id_array){  for (var i in id_array)  {    WB.client.parseCMD('/statuses/show/#{id}.json', function(sResult, bStatus)  {	var weiboText, from, from_id, created_time, photo;	weiboText= sResult.text;	created_time = sResult.created_at;	created_time = date_format(created_time);  	from = sResult.user.screen_name;	from_id = sResult.user.id;	photo = sResult.user.profile_image_url;	var content = ("<li class='weibo_drop'><div class='story_wrapper'><div><span class='weibo_text'>"+weiboText+"</span></div><div id='story_signature'><div style='float:right;'><a href='http://weibo.com/"+from_id+"' target='_blank'><img class='profile_img' style='width: 32px; height: 32px; overflow: hidden; margin-top:2px;' src='"+photo+"' alt='"+from+"' border=0 /></a></div><div id='signature_text' style='float:right; margin-right:5px;'><a class='weibo_from' href='http://weibo.com/"+from_id+"' target='_blank' style='display:block; height:16px;'><span>"+from+"</span></a><span class='weibo_date' style='display:block; height:16px;'>"+created_time+"</span></div></div></div></li>");	$('#weibo_ul').append(content);	$('.weibo_drop').css({'margin':'auto', 'width':'60%', 'margin-top':'10px', 'border':'none'});	},	{	  id : id_array[i]	},	{	  method: 'get'	});  }}$(function(){	$('#user_action').css('display', 'inline');	$('#publish_container').css({'margin':'auto', 'width':'80%'});	//$('.weibo_drop').css({'margin':'auto', 'width':'60%', 'margin-top':'10px', 'border':'none'});});	</script><?phpif(isset($_GET['post_id']) && !isset($_GET['action'])){	$post_id = $_GET['post_id'];	$result = $DB->fetch_one_array("select * from ".$db_prefix."posts where ID='".$post_id."'");	if(!$result)	{	  throw new Exception('Could not execute query.');	}	$story_title=$result['post_title'];	$story_summary=$result['post_summary'];	$story_status=$result['post_status'];	$story_content=$result['post_content'];	$story_content_array = json_decode($story_content, true);		if(0 == strcmp($story_status, 'Published'))	{	  $content = "<div class='div_center'><div id='publish_container' class='showborder'>			  <div id='story_action'><span>".$story_status."</span><span class='float_r'><a href='#'>通告			  </a> | <a href='/Storify/member/user.php?post_id=".$post_id."&action=remove'>删除</a> | <a href='/Storify/member/user.php?post_id=".$post_id."&action=edit'>编辑</a></span></div>";	}	else	{	  $content = "<div class='div_center'><div id='publish_container' class='showborder'>			  <div id='story_action'><span>".$story_status."</span><span class='float_r'><a href='/Storify/member/user.php?post_id=".$post_id."&action=remove'>删除			  </a> | <a href='/Storify/member/user.php?post_id=".$post_id."&action=edit'>编辑</a> | <a href='/Storify/member/user.php?post_id=".$post_id."&action=publish'>发布</a></span></div>";	}		$content .="<div style='padding-left:20px;'><h2>".$story_title."</h2></div>			  <div style='padding-left:20px;'>".$_SESSION['username']."</div>			  <div style='padding-left:20px; border-bottom:1px solid #C9C9C9;'>".$story_summary."</div>			  <ul id='weibo_ul' style='padding:0;'>";		foreach($story_content_array['content'] as $key=>$val)	{	  if($val['type'] === 'weibo')	  {	    $weibo_per_id = $val['content'];	    $content .="<li class='weibo_drop' id='$weibo_per_id' style='border:none;'></li>";	  }	  else if($val['type'] === 'comment')	  {	    $comment_text = $val['content'];		$content .="<li class='textElement'><div class='commentBox'>".$comment_text."</div></li>";			  }	}		$content .="</ul><div style='display: block; padding:0 10px 0 5px; text-align:right;'>Powered by <a name='poweredby' target='_blank' href='http://storybing.com'>StoryBing</a></div></div></div>";	echo $content;	echo "<script language='javascript' >			window.onload = function()			{			  $('.weibo_drop').each(function(){			  var weibo_permanent_id = $(this).attr('id');			  get_weibo_by_id(weibo_permanent_id);			  });			  $('.weibo_drop').css({'margin':'auto', 'width':'60%', 'margin-top':'10px', 'border':'none'});			}			</script>";}else if(isset($_GET['post_id']) && isset($_GET['action'])){	$story_id = $_GET['post_id'];	$story_action = $_GET['action'];	if(0 == strcmp($story_action, 'remove'))	{	  $result=$DB->query("DELETE FROM ".$db_prefix."posts where ID='".$story_id."'");	  go($rooturl.'/member/user.php');	}	else if(0 == strcmp($story_action, 'edit'))	{	  go($rooturl.'/member/index.php?post_id='.$story_id);	}	else if(0 == strcmp($story_action, 'publish'))	{	  $result=$DB->query("update ".$db_prefix."posts set post_status='Published'  WHERE ID='".$story_id."'");	  go($rooturl.'/member/user.php?post_id='.$story_id);	}	else	{	  throw new Exception('Undefined story action.');	}}else{  $story_content = "<div class='div_center'><div id='story_list'><ul>";  $result=$DB->query("SELECT * FROM ".$db_prefix."posts where post_author='".$_SESSION['uid']."'");  while ($story_item = mysql_fetch_array($result))  {    //printf ("title: %s  summary: %s", $story_item['post_title'], $story_item['post_summary']);	$post_title = $story_item['post_title'];    $story_content .= "<li><a href='/Storify/member/user.php?post_id=".$story_item['ID']."'><img src='/Storify/img/me.jpg' width='200' height='150' />".$post_title."</a></li>";  }  $story_content .="</ul></div></div>";  echo $story_content;}include "../include/footer.htm";?>