var embedCode,vtabIndex,followPage,myPage,favPage,userSearchPage,tuserSearchPage,myPageTimestamp,followTimestamp,favTimestamp,usersearchTimestamp;var weiboSearhPage=1,picSearchPage=1,userpicSearchPage=1,colSearchPage=1,recSearchPage=1,tweibosearchPage=1,doubanItemCounts=10,commentsPerQuery=5,eventStartIndex=1,bookStartIndex=1,bookReviewStartIndex=1,movieStartIndex=1,movieReviewStartIndex=1,musicStartIndex=1,musicReviewStartIndex=1,weibo_url="/weibo/weibooperation.php",tweibo_url="/tweibo/tweibooperation.php",douban_url="/douban/doubanoperation.php",yupoo_url="/yupoo/yupoooperation.php";if(typeof(window.innerHeight)=="number"){myHeight=window.innerHeight}else{if(document.documentElement&&document.documentElement.clientHeight){myHeight=document.documentElement.clientHeight}}var l_used_height=267,r_user_height=326,height_adjust=3,l_list_height=myHeight-l_used_height,r_list_height;var browser_info=$.browser;if(browser_info.mozilla){r_list_height=myHeight-r_user_height}else{if(browser_info.webkit){r_list_height=myHeight-r_user_height-height_adjust}else{if(browser_info.msie){r_list_height=myHeight-r_user_height+height_adjust}}}$("#source_list").css("height",l_list_height);$("#story_list").css("min-height",r_list_height);Array.prototype.getUnique=function(){var f={},c,d;for(c=0;d=this[c];c++){f[d]=1}var b=new Array();for(d in f){b.push(d)}return b};String.prototype.len=function(){return this.replace(/[^\x00-\xff]/g,"**").length};function bindonbeforeunload(){window.onbeforeunload=popalert}function unbindonbeforeunload(){window.onbeforeunload=null}function popalert(){return"本页面要求您确认您要离开 - 您输入的数据可能不会被保存"}function show_weibo_card(a){WB2.anyWhere(function(b){b.widget.hoverCard({id:a,search:true})})}function prepare_story_data(i){if(i!="Publish"&&i!="Preview"&&i!="Draft"){alert("not a proper operation:"+i)}var a;if(typeof(post_id)=="undefined"||post_id==null){a=0}else{a=post_id}var h=new Object;h.content=[];$("#story_list li:not(.addTextElementAnchor, .textElement.editing)").each(function(J){h.content[J]={};h.content[J].id=J;if($(this).hasClass("sina")){h.content[J].type="weibo";var x=$(this).attr("id").substr(2);var r=$(this).find(".weibo_from_drop").text();var n=$(this).find(".weibo_from_drop").attr("href").replace(/http:\/\/weibo.com\//,"");var E={id:x,nic:r,uid:n};h.content[J].content=E}else{if($(this).hasClass("tencent")){h.content[J].type="tweibo";var K=$(this).attr("id").substr(2);var I=$(this).find(".weibo_from_drop").text();var C=$(this).find(".weibo_from_drop").attr("href").replace(/http:\/\/t.qq.com\//,"");var N={id:K,nic:I,name:C};h.content[J].content=N}else{if($(this).hasClass("textElement")){h.content[J].type="comment";h.content[J].content=$(this).find(".commentBox").html()}else{if($(this).hasClass("douban")){var F=$(this).attr("class");var u=F.split(" ");var z=u.length;var G;for(G=0;G<z;G++){if(u[G]!="douban"&&u[G]!="douban_drop"){break}}var p;p=u[G];h.content[J].type="douban";var t=$(this).attr("id").substr(2);var o={item_type:p,item_id:t};h.content[J].content=o}else{if($(this).hasClass("video_drop")){h.content[J].type="video";var y=$(this).find(".videoTitle").text();var m=$(this).find("embed").attr("src");var M=$(this).find(".videoTitle").attr("href");var w={title:y,src:m,url:M};h.content[J].content=w}else{if($(this).hasClass("pic_drop")){h.content[J].type="photo";var H=$(this).find(".pic_title").text();var v=$(this).find(".pic_author").attr("href").replace(/http:\/\/www.yupoo.com\/photos\//,"");var s=$(this).find(".pic_author").text();var q=$(this).find(".pic_title").attr("href");var A=q.split("/");var L=A.length;var B=A[L-1];var D=$(this).find(".pic_img").attr("src");var l={id:B,title:H,author:v,nic:s,url:D};h.content[J].content=l}}}}}}});var e=JSON.stringify(h);var b=$("#sto_title").attr("value");var c=$("#sto_summary").val();var f=(c=="给你的故事写一个简短的描述"?"":c);var g=$("#sto_tag").attr("value");var j=(g=="添加故事标签，空格或逗号分隔"?"":g);var d=$("#story_thumbnail").attr("src");var k={story_id:a,story_title:b,story_summary:f,story_pic:d,story_tag:j,story_content:e,action:i};return k}function append_content(c,a){for(var b in c){var d=$(a[b]);$("#"+c[b]).append(d)}}function replaceURLWithHTMLLinks(a){var b=/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;replaced=a.replace(b,"<a href='$1' target='_blank'>$1</a>");return replaced}function remove_item(a){var c=$(a.target||a.srcElement).closest("li");if(c.index()==1&&!c.hasClass("textElement")&&!c.hasClass("video_drop")){var b;$("#story_list li:not(.addTextElementAnchor, .textElement, .video_drop)").each(function(d){if(d>0){if($(this).hasClass("sina")){b=$(this).find(".profile_img_drop").attr("src").replace(/(\d+)\/50\/(\d+)/,"$1/180/$2");return false}else{if($(this).hasClass("tencent")){b=$(this).find(".profile_img_drop").attr("src").replace(/50$/,"180");return false}else{if($(this).hasClass("douban")){if($(this).hasClass("book")||$(this).hasClass("movie")||$(this).hasClass("music")){b=$(this).find(".item_img").attr("src")}else{b=$(this).find(".profile_img_drop").attr("src")}return false}else{if($(this).hasClass("pic_drop")){b=$(this).find(".pic_img").attr("src").replace(/small$/,"square");return false}}}}}});$("#story_thumbnail").attr("src",b)}c.next("li").remove();c.remove();if($("#story_list li:not(.addTextElementAnchor, .textElement, .video_drop)").size()==0){$("#story_thumbnail").css("background-color","#EFEFEF").attr("src","")}}function change_story_pic(g){var f,b=[],d=b.length;$("#story_list li:not(.addTextElementAnchor, .textElement, .video_drop)").each(function(h){if($(this).hasClass("sina")){f=$(this).find(".profile_img_drop").attr("src").replace(/(\d+)\/50\/(\d+)/,"$1/180/$2");b[d]=f;d++}else{if($(this).hasClass("tencent")){f=$(this).find(".profile_img_drop").attr("src").replace(/50$/,"180");b[d]=f;d++}else{if($(this).hasClass("douban")){if($(this).hasClass("book")||$(this).hasClass("movie")||$(this).hasClass("music")){f=$(this).find(".item_img").attr("src")}else{f=$(this).find(".profile_img_drop").attr("src")}b[d]=f;d++}else{if($(this).hasClass("pic_drop")){f=$(this).find(".pic_img").attr("src").replace(/small$/,"square");b[d]=f;d++}}}}});b=b.getUnique();var e=b.length;var a=$("#story_thumbnail").attr("src");var c;for(c=0;c<e;c++){if(b[c]===a){break}}if(c==e){c=0}else{if(g=="next"){c=c+1;if(c==e){c=0}}else{if(g=="prev"){c=c-1;if(c<0){c=e-1}}}}$("#story_thumbnail").attr("src",b[c])}$(function(){var e=$("#weiboTabs").tabs();var b=$("#doubanTabs").tabs();var c=$("#picTabs").tabs();$("#keywords, #d_keywords, #videoUrl, #pic_keywords").bind("keyup",function(h){var g=h.keyCode||h.which;if(g==13){$(this).next().click()}});$("#connectBtn").live("click",function(g){g.preventDefault();$.post("/accounts/login/sina_auth.php",{},function(h,i){$("#dialog.window").hide();self.location=h})});$("#prev_img").click(function(g){g.preventDefault();change_story_pic("prev")});$("#next_img").click(function(g){g.preventDefault();change_story_pic("next")});$(".cross").live("click",function(g){g.preventDefault();remove_item(g)});show_weibo_card("story_list");var d=$("#sto_tag").val();if(d==" "){$("#sto_tag").val("添加故事标签，空格或逗号分隔").addClass("imply_color")}$("#keywords").val("关键字").addClass("imply_color");$("#keywords").blur(function(){if($(this).val()==""){var g=e.tabs("option","selected");if(g==0){$(this).val("关键字").addClass("imply_color")}else{if(g==1){$(this).val("微博用户名").addClass("imply_color")}}}}).focus(function(){var g=e.tabs("option","selected");if((g==0&&$(this).val()=="关键字")||(g==1&&$(this).val()=="微博用户名")){$(this).val("").removeClass("imply_color")}});$("#d_keywords").val("书名").addClass("imply_color");$("#videoUrl").val("浏览器地址栏url").addClass("imply_color");$("#videoUrl").blur(function(){if($(this).val()==""){$(this).val("浏览器地址栏url").addClass("imply_color")}}).focus(function(){if($(this).val()=="浏览器地址栏url"){$(this).val("").removeClass("imply_color")}});$("#book_tab").click(function(){bookStartIndex=1;$("#d_keywords").val("书名").addClass("imply_color");$("#source_list").children().remove()});$("#movie_tab").click(function(){movieStartIndex=1;$("#d_keywords").val("电影名").addClass("imply_color");$("#source_list").children().remove()});$("#music_tab").click(function(){musicStartIndex=1;$("#d_keywords").val("歌曲名").addClass("imply_color");$("#source_list").children().remove()});$("#event_tab").click(function(g){eventStartIndex=1;$("#d_keywords").val("搜活动").addClass("imply_color");$("#source_list").children().remove()});$("#d_keywords").blur(function(){if($(this).val()==""){$(this).addClass("imply_color");var g=b.tabs("option","selected");switch(g){case 0:$(this).val("书名");break;case 1:$(this).val("电影名");break;case 2:$(this).val("歌曲名");break;case 3:$(this).val("搜活动");break}}}).focus(function(){var h=b.tabs("option","selected");var g=$(this).val();if((h==0&&g=="书名")||(h==1&&g=="电影名")||(h==2&&g=="歌曲名")||(h==3&&g=="搜活动")){$(this).val("").removeClass("imply_color")}});$("#pic_keywords").val("关键字").addClass("imply_color");$("#pic_keywords").blur(function(){if($(this).val()==""){$(this).addClass("imply_color");var g=c.tabs("option","selected");if(g==0){$(this).val("关键字")}else{if(g==1||g==2){$(this).val("又拍用户名，注意不是昵称")}else{$(this).val("可指定日期如2010-6,默认搜索全部")}}}}).focus(function(){var g=c.tabs("option","selected");var h=$(this).val();if((g==0&&h=="关键字")||(g==1&&h=="又拍用户名，注意不是昵称")||(g==2&&h=="又拍用户名，注意不是昵称")||(g==3&&h=="可指定日期如2010-6,默认搜索全部")){$(this).val("").removeClass("imply_color")}});$("#my_tab").click(function(){$(".weibo_drag").remove();$(".loadmore").remove();$("#weibo_search").addClass("none");myPage=1;myPageTimestamp=0;if(0==vtabIndex){var h=true}if(h){if($(this).hasClass("sina_disable")){var j="<div class='bind_txt'><div class='imply_color'>查看我的关注需要绑定新浪微博帐号</div><a href='/accounts/source'>马上绑定</a></div>";$("#source_list").html(j);return false}}else{if($(this).hasClass("tencent_disable")){var j="<div class='bind_txt'><div class='imply_color'>查看我的广播需要绑定腾讯微博帐号</div><a href='/accounts/source'>马上绑定</a></div>";$("#source_list").html(j);return false}}var i,g;if(h){i=weibo_url;g={operation:"my_weibo",page:myPage}}else{i=tweibo_url;g={operation:"my_weibo",page:0,timestamp:myPageTimestamp}}$.ajax({type:"GET",url:i,data:g,beforeSend:function(){var k=$("<span class='loading_wrapper'><img src='../img/loading.gif' /></span>");$("#source_list").html(k)},success:function(k){$("#source_list").html(k);if(0==vtabIndex){show_weibo_card("source_list")}}})});$("#follow_tab").click(function(){$(".weibo_drag").remove();$(".loadmore").remove();$("#weibo_search").addClass("none");followPage=1;followTimestamp=0;if(0==vtabIndex){var h=true}if(h){if($(this).hasClass("sina_disable")){var j="<div class='bind_txt'><div class='imply_color'>查看我的关注需要绑定新浪微博帐号</div><a href='/accounts/source'>马上绑定</a></div>";$("#source_list").html(j);return false}}else{if($(this).hasClass("tencent_disable")){var j="<div class='bind_txt'><div class='imply_color'>查看我的收听需要绑定腾讯微博帐号</div><a href='/accounts/source'>马上绑定</a></div>";$("#source_list").html(j);return false}}var i,g;if(h){i=weibo_url;g={operation:"my_follow",page:followPage}}else{i=tweibo_url;g={operation:"my_follow",page:0,timestamp:followTimestamp}}$.ajax({type:"GET",url:i,data:g,beforeSend:function(){var k=$("<span class='loading_wrapper'><img src='../img/loading.gif' /></span>");$("#source_list").html(k)},success:function(k){$("#source_list").html(k);if(0==vtabIndex){show_weibo_card("source_list")}}})});$("#favorite_tab").click(function(){$(".weibo_drag").remove();$(".loadmore").remove();$("#weibo_search").addClass("none");favPage=1;favTimestamp=0;if(0==vtabIndex){var h=true}if(($(this).hasClass("sina_disable"))||($(this).hasClass("tencent_disable"))){var j="<div class='bind_txt'><div class='imply_color'>查看我的收藏需要绑定新浪微博帐号</div><a href='/accounts/source'>马上绑定</a></div>";$("#source_list").html(j);return false}var i,g;if(h){i=weibo_url;g={operation:"my_fav",page:favPage}}else{i=tweibo_url;g={operation:"my_fav",page:0,timestamp:favTimestamp}}$.ajax({type:"GET",url:i,data:g,beforeSend:function(){var k=$("<span class='loading_wrapper'><img src='../img/loading.gif' /></span>");$("#source_list").html(k)},success:function(k){$("#source_list").html(k);if(0==vtabIndex){show_weibo_card("source_list")}}})});$("#search_tab").click(function(i){weiboSearhPage=1;tweibosearchPage=1;$("#keywords").val("关键字").addClass("imply_color");$("#source_list").children().remove();if(0==vtabIndex){$("#weibo_search_btn").text("搜索话题");i.preventDefault();var h=weibo_url;var g;g={operation:"list_ht"};$.ajax({type:"GET",url:h,data:g,beforeSend:function(){var j=$("<span class='loading_wrapper'><img src='../img/loading.gif' /></span>");$("#source_list").html(j)},success:function(j){$("#source_list").html(j)}})}else{$("#weibo_search_btn").text("搜索微博")}$("#weibo_search").addClass("imply_color").removeClass("none")});$("#user_tab").click(function(){userSearchPage=1;tuserSearchPage=1;$("#keywords").val("微博用户名").addClass("imply_color");$("#source_list").children().remove();$("#weibo_search_btn").text("搜索用户");$("#weibo_search").addClass("imply_color").removeClass("none")});$("#weibo_search_btn").click(function(j){j.preventDefault();weiboSearhPage=1;userSearchPage=1;tuserSearchPage=1;tweibosearchPage=1;$(".loadmore").remove();var k=$("#keywords").val();var i=$("#weibo_search_btn").text();var h;var g;if(i==="搜索用户"){if(0==vtabIndex){h=weibo_url;g={operation:"user_search",keywords:k,page:userSearchPage}}else{h=tweibo_url;g={operation:"list_user",keywords:k,page:tuserSearchPage}}}else{if(0==vtabIndex){h=weibo_url;g={operation:"weibo_search",keywords:k,page:weiboSearhPage}}else{h=tweibo_url;g={operation:"weibo_search",keywords:k,page:tweibosearchPage}}}$.ajax({type:"GET",url:h,data:g,beforeSend:function(){var l=$("<span class='loading_wrapper'><img src='../img/loading.gif' /></span>");$("#source_list").html(l)},success:function(l){$("#source_list").html(l);if(0==vtabIndex){show_weibo_card("source_list")}}})});$("#douban_search_btn").click(function(k){k.preventDefault();var h=b.tabs("option","selected");var i=douban_url;var j=$("#d_keywords").val();var g;switch(h){case 0:g={operation:"book",keywords:j,startIndex:bookStartIndex,numResults:doubanItemCounts};break;case 1:g={operation:"movie",keywords:j,startIndex:movieStartIndex,numResults:doubanItemCounts};break;case 2:g={operation:"music",keywords:j,startIndex:musicStartIndex,numResults:doubanItemCounts};break;case 3:g={operation:"event",keywords:j,startIndex:eventStartIndex,numResults:doubanItemCounts};break;default:break}$.ajax({type:"GET",url:i,data:g,beforeSend:function(){var l=$("<span class='loading_wrapper'><img src='../img/loading.gif' /></span>");$("#source_list").html(l)},success:function(l){$("#source_list").html(l)}})});$("#search_tab_pic").click(function(){picSearchPage=1;$("#source_list").children().remove();$("#pic_keywords").val("关键字").addClass("imply_color")});$("#user_tab_pic").click(function(){userpicSearchPage=1;$("#source_list").children().remove();$("#pic_keywords").val("又拍用户名，注意不是昵称").addClass("imply_color")});$("#collect_tab_pic").click(function(){colSearchPage=1;$("#source_list").children().remove();$("#pic_keywords").val("又拍用户名，注意不是昵称").addClass("imply_color")});$("#recom_tab_pic").click(function(){recSearchPage=1;$("#source_list").children().remove();$("#pic_keywords").val("可指定日期如2010-6,默认搜索全部").addClass("imply_color")});$("#pic_search_btn").click(function(j){j.preventDefault();$(".loadmore").remove();var k=$("#pic_keywords").val();var i=c.tabs("option","selected");var h=yupoo_url;var g;if(0==i){g={operation:"pic_search",keywords:k,page:picSearchPage}}else{if(1==i){if($("#user_tab_pic").hasClass("yupoo_disable")){var l="<div class='bind_txt'><div class='imply_color'>用户搜索功能需要绑定又拍帐号</div><a href='/accounts/source'>马上绑定</a></div>";$("#source_list").html(l);return false}g={operation:"user_search",keywords:k,page:userpicSearchPage}}else{if(2==i){g={operation:"col_search",keywords:k,page:colSearchPage}}else{if(3==i){g={operation:"rec_search",keywords:k,page:recSearchPage}}}}}$.ajax({type:"GET",url:h,data:g,beforeSend:function(){var m=$("<span class='loading_wrapper'><img src='../img/loading.gif' /></span>");$("#source_list").html(m)},success:function(m){$("#source_list").html(m)}})});$("#source_list, #story_list").sortable({connectWith:".connectedSortable",cancel:".weibo_drop, .douban_drop, .video_drop, .textElement, .tuser, .loadmore, .ht_wrapper",receive:function(L,Q){var A=Q.item;var B=("<li class='addTextElementAnchor'><span><a class='add_comment'></a></span></li>");var J=A.prev("li");var U=A.next("li");if(!J.hasClass("addTextElementAnchor")){A.before(B)}if(!U.hasClass("addTextElementAnchor")){A.after(B)}var H=$("#story_list li:not(.addTextElementAnchor, .textElement, .video_drop)");if(A.hasClass("weibo_drag")){var N="";var y="";var u=A.find(".user_page").attr("href");var ab=A.find(".weibo_text").html();var T=A.find(".weibo_from").text();var w=A.find(".create_time").text();var V=A.find(".profile_img").attr("src");var q;if(A.hasClass("sina")){if(A.find(".weibo_img img").length!=0){var r=A.find(".weibo_img img").attr("src").replace(/thumbnail/,"bmiddle");N="<div class='weibo_img_drop'><img src='"+r+"' /></div>"}if(A.find(".weibo_retweet_img img").length!=0){var Z=A.find(".weibo_retweet_img img").attr("src").replace(/thumbnail/,"bmiddle");y="<div class='weibo_retweet_img_drop'><img src='"+Z+"' /></div>"}A.removeClass("weibo_drag").addClass("weibo_drop sina").children().remove();q=("<div class='cross' action='delete'></div><div class='handle'></div><div class='story_wrapper'><div class='content_wrapper'><span class='weibo_text_drop'>"+ab+"</span>"+y+N+"</div><div class='story_signature'><span class='float_r'><a href='"+u+"' target='_blank'><img class='profile_img_drop' src='"+V+"' alt='"+T+"' border=0 /></a></span><div class='signature_text_drop'><div class='text_wrapper'><span><a class='weibo_from_drop' href='"+u+"' target='_blank'>"+T+"</a></span></div><div class='weibo_date_drop'>"+w+"</div></div></div></div>");if(A.index(H)==0){$("#story_thumbnail").attr("src",V.replace(/(\d+)\/50\/(\d+)/,"$1/180/$2"))}}else{if(A.find(".weibo_img img").length!=0){var r=A.find(".weibo_img img").attr("src").replace(/120$/,"240");N="<div class='weibo_img_drop'><img src='"+r+"' /></div>"}if(A.find(".weibo_retweet_img img").length!=0){var Z=A.find(".weibo_retweet_img img").attr("src").replace(/120$/,"240");y="<div class='weibo_retweet_img_drop'><img src='"+Z+"' /></div>"}A.removeClass("weibo_drag").addClass("weibo_drop tencent").children().remove();q=("<div class='cross' action='delete'></div><div class='handle'></div><div class='story_wrapper'><div class='content_wrapper'><span class='weibo_text_drop'>"+ab+"</span>"+y+N+"</div><div class='story_signature'><span class='float_r'><a href='"+u+"' target='_blank'><img class='profile_img_drop' src='"+V+"' alt='"+T+"' border=0 /></a></span><div class='signature_text_drop'><div class='text_wrapper'><span ><a class='weibo_from_drop' href='"+u+"' target='_blank'>"+T+"</a></span></div><div class='weibo_date_drop'>"+w+"</div></div></div></div>");if(A.index(H)==0){$("#story_thumbnail").attr("src",V.replace(/50$/,"180"))}}A.append(q);if(0==vtabIndex){show_weibo_card(A.attr("id"))}}else{if(A.hasClass("douban_drag")){var D="";var l=A.find(".profile_img").attr("src");var C=A.find(".profile_img").attr("title");var h=A.find(".douban_from").attr("href");if(A.hasClass("event")){var n=A.find(".event_title a").text();var i=A.find(".event_summary").text();var ac=A.find(".event_initiator a").text();var m=A.find(".event_initiator a").attr("href");var Y=A.find(".start_time").text();var g=A.find(".end_time").text();var F=A.find(".event_title a").attr("href");var t=A.find(".event_img_wrapper img").attr("src");var S=A.find(".event_location").text();var P=A.find(".event_city").text();D=("<div class='cross' action='delete'></div><div class='handle'></div><div class='douban_wrapper'><div class='content_wrapper'><div class='event_summary_drop'>"+i+"</div><div class='event_wrapper'><a href='"+F+"' target='_blank'><img class='item_img_drop float_l' src='"+t+"' /></a><div class='item_meta_drop'><div class='event_title_drop'>活动：<a href='"+F+"' target='_blank'>"+n+"</a></div><div class='event_initiator_drop'>发起人：<a href='"+m+"' target='_blank'>"+ac+"</a></div><div class='start_time_drop'>"+Y+"</div><div class='end_time_drop'>"+g+"</div><div class='event_city_drop'>"+P+"</div><div class='event_location_drop'>"+S+"</div></div></div></div><div class='douban_signature'><span class='float_r'><a href='"+h+"' target='_blank'><img class='profile_img_drop' src='"+l+"' alt='"+C+"' border=0 /></a></span><span class='signature_text_drop'><div class='text_wrapper'><span ><a class='douban_from_drop' href='"+h+"' target='_blank'>"+C+"</a></span></div><div class='douban_date_drop'></div></span> </div></div>");A.removeClass("douban_drag").addClass("douban_drop").children().remove();if(A.index(H)==0){$("#story_thumbnail").attr("src",l)}A.append(D)}else{if(A.hasClass("bookReviews")||A.hasClass("movieReviews")||A.hasClass("musicReviews")){var x=A.find(".item_title").attr("href");var p=A.find(".comment_title").text();var ad=A.find(".comment_summary").html();var R=A.find(".comment_date").text();var M=A.find(".item_img").attr("src");var v=A.find(".item_title").text();var O=A.find(".item_author").text();var s=A.find(".item_date").text();var af=A.find(".average_rating").text();var o=A.find(".item_rating").text();D=("<div class='cross' action='delete'></div><div class='handle'></div><div class='douban_wrapper'><div class='content_wrapper'><div><div class='comment_title_drop'>"+p+"</div><div class='comment_summary_drop'>"+ad+"</div></div><div class='item_info_drop'><a href='"+x+"' target='_blank'><img class='item_img_drop float_l' src='"+M+"' /></a><div class='item_meta_drop'><div><a class='item_title_drop' href='"+x+"' target='_blank'>"+v+"</a></div><div class='item_author_drop'>"+O+"</div><div class='item_date_drop'>"+s+"</div><div class=item_rating_drop>"+o+"</div><div class='average_rating_drop'>"+af+"</div></div></div></div><div class='douban_signature'><span class='float_r'><a href='"+h+"' target='_blank'><img class='profile_img_drop' src='"+l+"' alt='"+C+"' border=0 /></a></span><span class='signature_text_drop'><div class='text_wrapper'><span ><a class='douban_from_drop' href='"+h+"' target='_blank'>"+C+"</a></span></div><div class='douban_date_drop'>"+R+"</div></span> </div></div>");A.removeClass("douban_drag").addClass("douban_drop").children().remove();if(A.index(H)==0){$("#story_thumbnail").attr("src",l)}A.append(D)}else{if(A.index(H)==0){$("#story_thumbnail").attr("src",A.find(".item_img").attr("src"))}A.removeClass("douban_drag").addClass("douban_drop");A.find(".douban_flag").removeClass().addClass("content_wrapper");A.find(".douban_review").closest("div").remove();A.prepend("<div class='cross' action='delete'></div><div class='handle'></div>")}}}else{if(A.hasClass("video_drag")){var X=A.find(".videoTitle").attr("href");var ae=A.find(".videoTitle").text();var j=("<div class='cross' action='delete'></div><div class='handle'></div><div class='youku_wrapper'><div><a class='videoTitle' target='_blank' href='"+X+"'>"+ae+"</a></div>"+embedCode+"</div>");A.removeClass("video_drag").addClass("video_drop").children().remove();A.append(j)}else{if(A.hasClass("pic_drag")){var I=A.find("img").attr("src");var G=A.find(".pic_title").text();var z=A.find(".pic_title").attr("href");var W=A.find(".pic_author").text();var E=A.find(".pic_author").attr("href");var k=I.split("/");var K=k.length;k[K-1]="small";I=k.join("/");var aa=("<div class='cross' action='delete'></div><div class='handle'></div><div class='yupoo_wrapper'><a target='_blank' href='"+z+"'><img class='pic_img' src='"+I+"'/></a><div><a class='pic_title' target='_blank' href='"+z+"'>"+G+"</a></div><div><a class='pic_author' target='_blank' href='"+E+"'>"+W+"</a></div><div class='yupoo_sign'></div></div>");A.removeClass("pic_drag").addClass("pic_drop").children().remove();A.append(aa);if(A.index(H)==0){$("#story_thumbnail").attr("src",I.replace(/small$/,"square"))}}}}}}});$("#embedVideo").click(function(j){j.preventDefault();var h=$("<span class='loading_wrapper'><img src='../img/loading.gif' /></span>");$("#source_list").html(h);var g;var i=$("#videoUrl").val();$.embedly(i,{key:"4ac512dca79011e0aeec4040d3dc5c07",maxWidth:420,wrapElement:"div",method:"afterParent"},function(k){if(k!=null){embedCode=k.code;g=k.title;var l="<li class='video_drag'><div class='urlWrapper'><div><a class='videoTitle' target='_blank' href='"+i+"'>"+k.title+"</a></div><div class='videoContent'><div class='video_domain'><div class='video_favicon'></div><div class='video_author'><a target='_blank' href='"+i+"'>v.youku.com</a></div></div><div><img class='youku_thumbnail' src='"+k.thumbnail_url+"' /><div class='video_description'>"+k.description+"</div></div></div></div></li>";$("#source_list").html(l)}})});if($("#sto_title").val()==""){$("#sto_title").val("你的故事标题").removeClass("imply_color").focus(function(){if($(this).val()=="你的故事标题"){$(this).val("").removeClass("imply_color")}}).blur(function(){if($(this).val()==""){$(this).val("你的故事标题").removeClass("imply_color")}})}if($("#sto_summary").val()==""){$("#sto_summary").val("给你的故事写一个简短的描述").addClass("imply_color").focus(function(){if($(this).val()=="给你的故事写一个简短的描述"){$(this).val("").removeClass("imply_color")}}).blur(function(){if($(this).val()==""){$(this).val("给你的故事写一个简短的描述").addClass("imply_color")}})}if($("#sto_tag").val()==""){$("#sto_tag").val("添加故事标签，空格或逗号分隔").addClass("imply_color").focus(function(){if($(this).val()=="添加故事标签，空格或逗号分隔"){$(this).val("").removeClass("imply_color")}}).blur(function(){if($(this).val()==""){$(this).val("添加故事标签，空格或逗号分隔").addClass("imply_color")}})}$("#story_list li").live("mouseover",function(g){$(this).find(".cross").css("visibility","visible")});$("#story_list li").live("mouseout",function(g){$(this).find(".cross").css("visibility","hidden")});$("#actions").click(function(l){l.preventDefault();unbindonbeforeunload();if($(l.target).hasClass("disable")){var i=$(window).height();var n=$(window).width();var g=$(document).scrollTop();var h=$(document).scrollLeft();var m=$("#boxes #dialog");m.css("top",i/2-m.height()/2+g-100);m.css("left",n/2-m.width()/2+h);m.fadeIn(1000)}else{var j=$("#sto_title").attr("value");var o;var k="/member/publish.php";if($(l.target).is("#publishBtn")){o=prepare_story_data("Publish")}else{if($(l.target).is("#previewBtn")){o=prepare_story_data("Preview")}else{o=prepare_story_data("Draft")}}if($(l.target).is("#publishBtn")&&j=="你的故事标题"){alert("请为你的故事输入一个标题");$("#sto_title").focus()}else{$.post(k,o,function(p,q){self.location=p})}}});$(".douban_review").live("click",function(i){i.preventDefault();var h="/douban/doubanreviewsoperation.php";var g;var j=$(this).closest(".douban_drag").attr("id").substr(2);if($(this).hasClass("book")){g={operation:"bookReviews",subjectID:j,startIndex:bookReviewStartIndex,numResults:commentsPerQuery}}else{if($(this).hasClass("movie")){g={operation:"movieReviews",subjectID:j,startIndex:movieReviewStartIndex,numResults:commentsPerQuery}}else{if($(this).hasClass("music")){g={operation:"musicReviews",subjectID:j,startIndex:musicReviewStartIndex,numResults:commentsPerQuery}}}}$.ajax({type:"GET",url:h,data:g,beforeSend:function(){var k=$("<span class='loading_wrapper'><img src='../img/loading.gif' /></span>");$("#source_list").html(k)},success:function(k){$("#source_list").html(k)}})});$(".list_tweibo").live("click",function(j){usersearchTimestamp=0;j.preventDefault();var h=tweibo_url;var g;var i=$(this).closest(".weibo_drag").attr("id");g={operation:"user_search",keywords:i,page:0,timestamp:usersearchTimestamp};$.ajax({type:"GET",url:h,data:g,beforeSend:function(){var k=$("<span class='loading_wrapper'><img src='../img/loading.gif' /></span>");$("#source_list").html(k)},success:function(k){$("#source_list").html(k)}})});$(".list_t_weibo").live("click",function(i){i.preventDefault();weiboSearhPage=1;var h=weibo_url;var g;var j=$(this).text();g={operation:"weibo_search",keywords:j,page:weiboSearhPage};$.ajax({type:"GET",url:h,data:g,beforeSend:function(){var k=$("<span class='loading_wrapper'><img src='../img/loading.gif' /></span>");$("#source_list").html(k)},success:function(k){$("#source_list").html(k);show_weibo_card("source_list")}})});$("#source_list").click(function(l){var j;if(0==vtabIndex||1==vtabIndex){j=e.tabs("option","selected")}else{if(2==vtabIndex){j=b.tabs("option","selected")}else{if(4==vtabIndex){j=c.tabs("option","selected")}}}if($(l.target).is(".loadmore")){var i;var g;if(0==j){var m;if(0==vtabIndex){m=$("#keywords").val();i=weibo_url;weiboSearhPage++;g={operation:"weibo_search",keywords:m,page:weiboSearhPage}}else{if(1==vtabIndex){m=$("#keywords").val();i=tweibo_url;tweibosearchPage++;g={operation:"weibo_search",keywords:m,page:tweibosearchPage}}else{if(2==vtabIndex){var h=$(".loadmore");if(h.hasClass("book")){i=douban_url;bookStartIndex=bookStartIndex+doubanItemCounts;g={operation:"book",keywords:$("#d_keywords").val(),startIndex:bookStartIndex,numResults:doubanItemCounts}}else{if(h.hasClass("bookReviews")){i="/douban/doubanreviewsoperation.php";bookReviewStartIndex=bookReviewStartIndex+commentsPerQuery;g={operation:"bookReviews",subjectID:h.attr("id"),startIndex:bookReviewStartIndex,numResults:commentsPerQuery}}}}else{if(4==vtabIndex){m=$("#pic_keywords").val();i=yupoo_url;picSearchPage++;g={operation:"pic_search",keywords:m,page:picSearchPage}}}}}$(".loadmore").remove();$.get(i,g,function(n,o){$("#source_list").append(n);if(0==vtabIndex){show_weibo_card("source_list")}})}else{if(1==j){if(0==vtabIndex){i=weibo_url;userSearchPage++;g={operation:"user_search",keywords:$("#keywords").val(),page:userSearchPage}}else{if(1==vtabIndex){i=tweibo_url;if($(l.target).closest(".loadmore").hasClass("tuser")){tuserSearchPage++;g={operation:"list_user",keywords:$("#keywords").val(),page:tuserSearchPage}}else{var k=$(".loadmore").prev().find(".user_page").attr("href").replace(/http:\/\/t.qq.com\//,"");usersearchTimestamp=$(".loadmore span").attr("id");g={operation:"user_search",keywords:k,page:1,timestamp:usersearchTimestamp}}}else{if(2==vtabIndex){var h=$(".loadmore");if(h.hasClass("movie")){i=douban_url;movieStartIndex=movieStartIndex+doubanItemCounts;g={operation:"movie",keywords:$("#d_keywords").val(),startIndex:movieStartIndex,numResults:doubanItemCounts}}else{if(h.hasClass("movieReviews")){i="/douban/doubanreviewsoperation.php";movieReviewStartIndex=movieReviewStartIndex+commentsPerQuery;g={operation:"movieReviews",subjectID:h.attr("id"),startIndex:movieReviewStartIndex,numResults:commentsPerQuery}}}}else{if(4==vtabIndex){m=$("#pic_keywords").val();i=yupoo_url;userpicSearchPage++;g={operation:"user_search",keywords:m,page:userpicSearchPage}}}}}$(".loadmore").remove();$.get(i,g,function(n,o){$("#source_list").append(n);if(0==vtabIndex){show_weibo_card("source_list")}})}else{if(2==j){if(0==vtabIndex){i=weibo_url;myPage++;g={operation:"my_weibo",page:myPage}}else{if(1==vtabIndex){i=tweibo_url;myPageTimestamp=$(".loadmore span").attr("id");g={operation:"my_weibo",page:1,timestamp:myPageTimestamp}}else{if(2==vtabIndex){var h=$(".loadmore");if(h.hasClass("music")){i=douban_url;musicStartIndex=musicStartIndex+doubanItemCounts;g={operation:"music",keywords:$("#d_keywords").val(),startIndex:musicStartIndex,numResults:doubanItemCounts}}else{if(h.hasClass("musicReviews")){i="/douban/doubanreviewsoperation.php";musicReviewStartIndex=musicReviewStartIndex+commentsPerQuery;g={operation:"musicReviews",subjectID:h.attr("id"),startIndex:musicReviewStartIndex,numResults:commentsPerQuery}}}}else{if(4==vtabIndex){m=$("#pic_keywords").val();i=yupoo_url;colSearchPage++;g={operation:"col_search",keywords:m,page:colSearchPage}}}}}$(".loadmore").remove();$.get(i,g,function(n,o){$("#source_list").append(n);if(0==vtabIndex){show_weibo_card("source_list")}})}else{if(3==j){if(0==vtabIndex){i=weibo_url;followPage++;g={operation:"my_follow",page:followPage}}else{if(1==vtabIndex){i=tweibo_url;followTimestamp=$(".loadmore span").attr("id");g={operation:"my_follow",page:1,timestamp:followTimestamp}}else{if(2==vtabIndex){i=douban_url;eventStartIndex=eventStartIndex+doubanItemCounts;g={operation:"event",keywords:$("#d_keywords").val(),startIndex:eventStartIndex,numResults:doubanItemCounts}}else{if(4==vtabIndex){m=$("#pic_keywords").val();i=yupoo_url;recSearchPage++;g={operation:"rec_search",keywords:m,page:recSearchPage}}}}}$(".loadmore").remove();$.get(i,g,function(n,o){$("#source_list").append(n);if(0==vtabIndex){show_weibo_card("source_list")}})}else{if(0==vtabIndex){i=weibo_url;favPage++;g={operation:"my_fav",page:favPage}}else{if(1==vtabIndex){i=tweibo_url;favTimestamp=$(".loadmore span").attr("id");g={operation:"my_fav",page:1,timestamp:favTimestamp}}}$(".loadmore").remove();$.get(i,g,function(n,o){$("#source_list").append(n);if(0==vtabIndex){show_weibo_card("source_list")}})}}}}}});$(".addTextElementAnchor").live("mouseenter",function(){$(this).css("background-color","#FDFFD2").append('<span class="add_text">点击添加文字</span>')}).live("mouseleave",function(){$(this).css("background-color","#FFFFFF").find(".add_text").remove()});$("#story_list").click(function(j){if($(j.target).is(".add_comment")||$(j.target).is(".add_text")||$(j.target).is(".addTextElementAnchor")){j.preventDefault();var g=$("<li class='textElement editing'><div class='editingDiv'><form class='formTextElement'><textarea class='inputEditor' name='inputEditor'></textarea></form><div class='belowTextEdit'><div class='actions'><button class='submit submitComment' type='submit'>确定</button><button class='cancel cancelEditor' type='reset'>取消</button></div></div></div></li><li class='addTextElementAnchor'><span><a class='add_comment'></a></span></li>");$(j.target).closest("li").after(g);$(".inputEditor").cleditor({width:476,height:150,controls:"bold italic underline strikethrough link | font size"})}if($(j.target).is(".cancelEditor")){j.preventDefault();$(j.target).closest(".textElement").next(".addTextElementAnchor").remove();$(j.target).closest(".textElement").remove()}if($(j.target).is(".submitComment")){j.preventDefault();var i=$(j.target).closest(".textElement");var k=i.find(".inputEditor").val();if(k==""||k=="<br>"){$(j.target).closest(".textElement").next(".addTextElementAnchor").remove();$(j.target).closest(".textElement").remove()}else{$(j.target).closest(".editingDiv").remove();var h=$("<div class='cross' action='delete'></div><div class='handle'></div><div class='commentBox'>"+k+"</div>");i.removeClass("editing").addClass("editted").append(h)}}});var f=$("#vtab>ul>li");var a=0;f.click(function(){f.removeClass("selected");$(this).addClass("selected");vtabIndex=f.index($(this));if(1==vtabIndex){$("#search_tab").text("微博搜索");$("#my_tab").text("我的广播");$("#follow_tab").text("我的收听");$("#weibo_search_btn").text("搜索微博");if(1!=a){e.tabs("select",0);$("#weibo_search").removeClass("none");$("#source_list").children().remove();$("#keywords").val("关键字").addClass("imply_color")}a=1;$("#vtab>div").hide().eq(vtabIndex-1).show()}else{if(2==vtabIndex){if(2!=a){b.tabs("select",0);$("#source_list").children().remove();$("#d_keywords").val("书名").addClass("imply_color")}a=2;$("#vtab>div").hide().eq(vtabIndex-1).show()}else{if(3==vtabIndex){if(3!=a){$("#source_list").children().remove()}a=3;$("#vtab>div").hide().eq(vtabIndex-1).show()}else{if(4==vtabIndex){if(4!=a){c.tabs("select",0);$("#source_list").children().remove();$("#pic_keywords").val("关键字").addClass("imply_color")}a=4;$("#vtab>div").hide().eq(vtabIndex-1).show()}else{$("#search_tab").text("话题搜索");$("#my_tab").text("我的微博");$("#follow_tab").text("我的关注");$("#weibo_search_btn").text("搜索话题");$("#keywords").val("关键字").addClass("imply_color");if(0!=a){e.tabs("select",0);$("#weibo_search").removeClass("none");$("#source_list").children().remove();var h=weibo_url;var g;g={operation:"list_ht"};$.ajax({type:"GET",url:h,data:g,beforeSend:function(){var i=$("<span class='loading_wrapper'><img src='../img/loading.gif' /></span>");$("#source_list").html(i)},success:function(i){$("#source_list").html(i)}})}a=0;$("#vtab>div").hide().eq(vtabIndex).show()}}}}}).eq(0).click();$(".window .close").click(function(g){g.preventDefault();$("#mask").hide();$(".window").hide()});$("#mask").click(function(){$(this).hide();$(".window").hide()})});