var embedCode,vtabIndex,followPage,myPage,favPage,userSearchPage,tuserSearchPage,myPageTimestamp,followTimestamp,favTimestamp,usersearchTimestamp;var weiboSearhPage=1,picSearchPage=1,userpicSearchPage=1,colSearchPage=1,recSearchPage=1,tweibosearchPage=1,doubanItemCounts=10,commentsPerQuery=5,eventStartIndex=1,bookStartIndex=1,bookReviewStartIndex=1,movieStartIndex=1,movieReviewStartIndex=1,musicStartIndex=1,musicReviewStartIndex=1,weibo_url="/weibo/weibooperation.php",tweibo_url="/tweibo/tweibooperation.php",douban_url="/douban/doubanoperation.php",douban_rurl="/douban/doubanreviewsoperation.php",yupoo_url="/yupoo/yupoooperation.php";if(typeof(window.innerHeight)=="number"){myHeight=window.innerHeight}else{if(document.documentElement&&document.documentElement.clientHeight){myHeight=document.documentElement.clientHeight}}var l_used_height=267,r_user_height=326,height_adjust=3,l_list_height=myHeight-l_used_height,r_list_height;var browser_info=$.browser;if(browser_info.mozilla){r_list_height=myHeight-r_user_height}else{if(browser_info.webkit){r_list_height=myHeight-r_user_height-height_adjust}else{if(browser_info.msie){r_list_height=myHeight-r_user_height+height_adjust}}}$("#source_list").css("height",l_list_height);$("#story_list").css("min-height",r_list_height);Array.prototype.getUnique=function(){var f={},c,d;for(c=0;d=this[c];c++){f[d]=1}var b=new Array();for(d in f){b.push(d)}return b};String.prototype.len=function(){return this.replace(/[^\x00-\xff]/g,"**").length};function bindonbeforeunload(){window.onbeforeunload=popalert}function unbindonbeforeunload(){window.onbeforeunload=null}function popalert(){return"本页面要求您确认您要离开 - 您输入的数据可能不会被保存"}function createCookie(c,d,e){if(e){var b=new Date();b.setTime(b.getTime()+(e*24*60*60*1000));var a="; expires="+b.toGMTString()}else{var a=""}document.cookie=c+"="+d+a+"; path=/"}function readCookie(b){var e=b+"=";var a=document.cookie.split(";");for(var d=0;d<a.length;d++){var f=a[d];while(f.charAt(0)==" "){f=f.substring(1,f.length)}if(f.indexOf(e)==0){return f.substring(e.length,f.length)}}return null}function eraseCookie(a){createCookie(a,"",-1)}function show_weibo_card(a){WB2.anyWhere(function(b){b.widget.hoverCard({id:a,search:true})})}function prepare_story_data(i){if(i!="Publish"&&i!="Preview"&&i!="Draft"){alert("not a proper operation:"+i)}var a;if(typeof(post_id)=="undefined"||post_id==null){a=0}else{a=post_id}var h=new Object;h.content=[];$("#story_list li:not(.addTextElementAnchor)").each(function(K){h.content[K]={};h.content[K].id=K;if($(this).hasClass("sina")){h.content[K].type="weibo";var y=$(this).attr("id").substr(2);var s=$(this).find(".weibo_from_drop").text();var n=$(this).find(".weibo_from_drop").attr("href").replace(/http:\/\/weibo.com\//,"");var F={id:y,nic:s,uid:n};h.content[K].content=F}else{if($(this).hasClass("tencent")){h.content[K].type="tweibo";var L=$(this).attr("id").substr(2);var J=$(this).find(".weibo_from_drop").text();var D=$(this).find(".weibo_from_drop").attr("href").replace(/http:\/\/t.qq.com\//,"");var O={id:L,nic:J,name:D};h.content[K].content=O}else{if($(this).hasClass("img_upload_drop")){h.content[K].type="upload_img";h.content[K].content=$(this).find("img").attr("src")}else{if($(this).hasClass("textElement")){if($(this).hasClass("editing")){var o=$(this).find(".inputEditor").val();temp=o.replace(/(\&nbsp;|\<br\>)/g,"");temp=$.trim(temp);if(!(temp=="")){h.content[K].type="comment";h.content[K].content=o}}else{h.content[K].type="comment";h.content[K].content=$(this).find(".commentBox").html()}}else{if($(this).hasClass("douban")){var G=$(this).attr("class");var v=G.split(" ");var A=v.length;var H;for(H=0;H<A;H++){if(v[H]!="douban"&&v[H]!="douban_drop"){break}}var q;q=v[H];h.content[K].type="douban";var u=$(this).attr("id").substr(2);var p={item_type:q,item_id:u};h.content[K].content=p}else{if($(this).hasClass("video_drop")){h.content[K].type="video";var z=$(this).find(".videoTitle").text();var m=$(this).find("embed").attr("src");var N=$(this).find(".videoTitle").attr("href");var x={title:z,src:m,url:N};h.content[K].content=x}else{if($(this).hasClass("pic_drop")){h.content[K].type="photo";var I=$(this).find(".pic_title").text();var w=$(this).find(".pic_author").attr("href").replace(/http:\/\/www.yupoo.com\/photos\//,"");var t=$(this).find(".pic_author").text();var r=$(this).find(".pic_title").attr("href");var B=r.split("/");var M=B.length;var C=B[M-1];var E=$(this).find(".pic_img").attr("src");var l={id:C,title:I,author:w,nic:t,url:E};h.content[K].content=l}}}}}}}});var e=JSON.stringify(h);var b=$("#sto_title").attr("value");var c=$("#sto_summary").val();var f=(c=="给你的故事写一个简短的描述"?"":c);var g=$("#sto_tag").attr("value");var j=(g=="添加故事标签，空格或逗号分隔"?"":g);var d=$("#story_thumbnail").attr("src");var k={story_id:a,story_title:b,story_summary:f,story_pic:d,story_tag:j,story_content:e,action:i};return k}function remove_item(b){var e=$(b.target||b.srcElement).closest("li");if(e.hasClass("img_upload_drop")){var c=true,d=e.find("img").attr("src").substr(12)}e.next("li").remove();e.hide("slow",function(){e.remove()});if(c){var a={file:d};$.get("/member/imgdelete.php",a)}}function change_story_pic(g){var f,b=[],d=b.length;$("#story_list img").each(function(h){f=$(this).attr("src");if(f!=""){if($(this).hasClass("profile_img_drop")){if($(this).closest("li").hasClass("sina")){f=f.replace(/(\d+)\/50\/(\d+)/,"$1/180/$2")}else{if($(this).closest("li").hasClass("tencent")){f=f.replace(/50$/,"180")}}}b[d]=f;d++}});b=b.getUnique();var e=b.length;var a=$("#story_thumbnail").attr("src");var c;for(c=0;c<e;c++){if(b[c]===a){break}}if(c==e){c=0}else{if(g=="next"){c=c+1;if(c==e){c=0}}else{if(g=="prev"){c=c-1;if(c<0){c=e-1}}}}$("#story_thumbnail").attr("src",b[c])}$(function(){var f=$("#weiboTabs").tabs();var b=$("#doubanTabs").tabs();var i=$("#picTabs").tabs();if(null==readCookie("editortip")){var h="<div id='first_tip' class='tip_container'><div class='tip_arrow top'></div><div class='tip_wrapper'><strong>小贴士1/4: 开始创建</strong><br>输入故事标题，描述，标签<br>左右箭头可以用来选择故事的封面<div class='tip_actions'><a class='tip_hide' href='#'>隐藏</a><a class='tip_next' href='#'>下一条 &raquo;</a></div></div></div>";$("#storyContent .inner").prepend(h);createCookie("editortip","tippopflag",365)}$("#first_tip .tip_next").live("click",function(){$("#first_tip").remove();var j="<div id='second_tip' class='tip_container'><div class='tip_arrow left'></div><div class='tip_wrapper'><strong>小贴士2/4: 寻找素材</strong><br>切换信息源来寻找喜欢的素材<div class='tip_actions'><a class='tip_hide' href='#'>隐藏</a><a class='tip_next' href='#'>下一条 &raquo;</a></div></div></div>";$("#storyContent .inner").prepend(j)});$("#second_tip .tip_next").live("click",function(){$("#second_tip").remove();var j="<div id='third_tip' class='tip_container'><div class='tip_arrow left'></div><div class='tip_arrow right'></div><div class='tip_wrapper'><strong>小贴士3/4: 组织素材</strong><br>将喜欢的素材从左栏拖放到右栏<br>别忘了可以选择放置的位置<div class='tip_actions'><a class='tip_hide' href='#'>隐藏</a><a class='tip_next' href='#'>下一条 &raquo;</a></div></div></div>";$("#storyContent .inner").prepend(j)});$("#third_tip .tip_next").live("click",function(){$("#third_tip").remove();var j="<div id='fourth_tip' class='tip_container'><div class='tip_arrow top'></div><div class='tip_wrapper'><strong>小贴士4/4: 添加文字</strong><br>点击T图标给故事添加文字<div class='tip_actions'><a class='tip_hide' href='#'>隐藏</a></div></div></div>";$("#storyContent .inner").prepend(j)});$(".tip_container .tip_hide").live("click",function(){$(".tip_container").remove()});$("#keywords, #d_keywords, #videoUrl, #pic_keywords").bind("keyup",function(k){var j=k.keyCode||k.which;if(j==13){$(this).next().click()}});$("#connectBtn").live("click",function(j){j.preventDefault();$.post("/accounts/login/sina_auth.php",{},function(k,l){$("#dialog.window").hide();self.location=k})});$("#prev_img").click(function(j){j.preventDefault();change_story_pic("prev")});$("#next_img").click(function(j){j.preventDefault();change_story_pic("next")});$(".cross").live("click",function(j){j.preventDefault();remove_item(j)});show_weibo_card("story_list");var c=$("#sto_tag").val();if(c==" "){$("#sto_tag").val("添加故事标签，空格或逗号分隔").addClass("imply_color")}$("#keywords").val("关键字").addClass("imply_color");$("#keywords").blur(function(){if($(this).val()==""){var j=f.tabs("option","selected");if(j==0){$(this).val("关键字").addClass("imply_color")}else{if(j==1){$(this).val("微博用户名").addClass("imply_color")}}}}).focus(function(){var j=f.tabs("option","selected");if((j==0&&$(this).val()=="关键字")||(j==1&&$(this).val()=="微博用户名")){$(this).val("").removeClass("imply_color")}});$("#d_keywords").val("书名").addClass("imply_color");$("#videoUrl").val("浏览器地址栏url").addClass("imply_color");$("#videoUrl").blur(function(){if($(this).val()==""){$(this).val("浏览器地址栏url").addClass("imply_color")}}).focus(function(){if($(this).val()=="浏览器地址栏url"){$(this).val("").removeClass("imply_color")}});$("#book_tab").click(function(){bookStartIndex=1;if($("#d_keywords").hasClass("imply_color")){$("#d_keywords").val("书名")}$("#source_list").children().remove()});$("#movie_tab").click(function(){movieStartIndex=1;if($("#d_keywords").hasClass("imply_color")){$("#d_keywords").val("电影名")}$("#source_list").children().remove()});$("#music_tab").click(function(){musicStartIndex=1;if($("#d_keywords").hasClass("imply_color")){$("#d_keywords").val("歌曲名")}$("#source_list").children().remove()});$("#event_tab").click(function(j){eventStartIndex=1;if($("#d_keywords").hasClass("imply_color")){$("#d_keywords").val("搜活动")}$("#source_list").children().remove()});$("#d_keywords").blur(function(){if($(this).val()==""){$(this).addClass("imply_color");var j=b.tabs("option","selected");switch(j){case 0:$(this).val("书名");break;case 1:$(this).val("电影名");break;case 2:$(this).val("歌曲名");break;case 3:$(this).val("搜活动");break}}}).focus(function(){var k=b.tabs("option","selected");var j=$(this).val();if((k==0&&j=="书名")||(k==1&&j=="电影名")||(k==2&&j=="歌曲名")||(k==3&&j=="搜活动")){$(this).val("").removeClass("imply_color")}});$("#pic_keywords").val("关键字").addClass("imply_color");$("#pic_keywords").blur(function(){if($(this).val()==""){$(this).addClass("imply_color");var j=i.tabs("option","selected");if(j==0){$(this).val("关键字")}else{if(j==1||j==2){$(this).val("又拍用户名，注意不是昵称")}else{$(this).val("可指定日期如2010-6,默认搜索全部")}}}}).focus(function(){var j=i.tabs("option","selected");var k=$(this).val();if((j==0&&k=="关键字")||(j==1&&k=="又拍用户名，注意不是昵称")||(j==2&&k=="又拍用户名，注意不是昵称")||(j==3&&k=="可指定日期如2010-6,默认搜索全部")){$(this).val("").removeClass("imply_color")}});$("#my_tab").click(function(){$(".weibo_drag").remove();$(".loadmore").remove();$("#weibo_search").addClass("none");myPage=1;myPageTimestamp=0;if(0==vtabIndex){var k=true}if(k){if($(this).hasClass("sina_disable")){var m="<div class='bind_txt'><div class='imply_color'>查看我的关注需要绑定新浪微博帐号</div><a href='/accounts/source'>马上绑定</a></div>";$("#source_list").html(m);return false}}else{if($(this).hasClass("tencent_disable")){var m="<div class='bind_txt'><div class='imply_color'>查看我的广播需要绑定腾讯微博帐号</div><a href='/accounts/source'>马上绑定</a></div>";$("#source_list").html(m);return false}}var l,j;if(k){l=weibo_url;j={operation:"my_weibo",page:myPage}}else{l=tweibo_url;j={operation:"my_weibo",page:0,timestamp:myPageTimestamp}}$.ajax({type:"GET",url:l,data:j,beforeSend:function(){var n=$("<span class='loading_wrapper'><img src='../img/loading.gif' /></span>");$("#source_list").html(n)},success:function(n){$("#source_list").html(n);if(0==vtabIndex){show_weibo_card("source_list")}}})});$("#follow_tab").click(function(){$(".weibo_drag").remove();$(".loadmore").remove();$("#weibo_search").addClass("none");followPage=1;followTimestamp=0;if(0==vtabIndex){var k=true}if(k){if($(this).hasClass("sina_disable")){var m="<div class='bind_txt'><div class='imply_color'>查看我的关注需要绑定新浪微博帐号</div><a href='/accounts/source'>马上绑定</a></div>";$("#source_list").html(m);return false}}else{if($(this).hasClass("tencent_disable")){var m="<div class='bind_txt'><div class='imply_color'>查看我的收听需要绑定腾讯微博帐号</div><a href='/accounts/source'>马上绑定</a></div>";$("#source_list").html(m);return false}}var l,j;if(k){l=weibo_url;j={operation:"my_follow",page:followPage}}else{l=tweibo_url;j={operation:"my_follow",page:0,timestamp:followTimestamp}}$.ajax({type:"GET",url:l,data:j,beforeSend:function(){var n=$("<span class='loading_wrapper'><img src='../img/loading.gif' /></span>");$("#source_list").html(n)},success:function(n){$("#source_list").html(n);if(0==vtabIndex){show_weibo_card("source_list")}}})});$("#favorite_tab").click(function(){$(".weibo_drag").remove();$(".loadmore").remove();$("#weibo_search").addClass("none");favPage=1;favTimestamp=0;if(0==vtabIndex){var k=true}if(k){if($(this).hasClass("sina_disable")){var m="<div class='bind_txt'><div class='imply_color'>查看我的关注需要绑定新浪微博帐号</div><a href='/accounts/source'>马上绑定</a></div>";$("#source_list").html(m);return false}}else{if($(this).hasClass("tencent_disable")){var m="<div class='bind_txt'><div class='imply_color'>查看我的收听需要绑定腾讯微博帐号</div><a href='/accounts/source'>马上绑定</a></div>";$("#source_list").html(m);return false}}var l,j;if(k){l=weibo_url;j={operation:"my_fav",page:favPage}}else{l=tweibo_url;j={operation:"my_fav",page:0,timestamp:favTimestamp}}$.ajax({type:"GET",url:l,data:j,beforeSend:function(){var n=$("<span class='loading_wrapper'><img src='../img/loading.gif' /></span>");$("#source_list").html(n)},success:function(n){$("#source_list").html(n);if(0==vtabIndex){show_weibo_card("source_list")}}})});$("#search_tab").click(function(l){weiboSearhPage=1;tweibosearchPage=1;if($("#keywords").hasClass("imply_color")){$("#keywords").val("关键字")}$("#source_list").children().remove();if(0==vtabIndex){$("#weibo_search_btn").text("搜索话题");l.preventDefault();var k=weibo_url;var j;j={operation:"list_ht"};$.ajax({type:"GET",url:k,data:j,beforeSend:function(){var m=$("<span class='loading_wrapper'><img src='../img/loading.gif' /></span>");$("#source_list").html(m)},success:function(m){$("#source_list").html(m)}})}else{$("#weibo_search_btn").text("搜索微博")}$("#weibo_search").addClass("imply_color").removeClass("none")});$("#user_tab").click(function(){userSearchPage=1;tuserSearchPage=1;if($("#keywords").hasClass("imply_color")){$("#keywords").val("微博用户名")}$("#source_list").children().remove();$("#weibo_search_btn").text("搜索用户");$("#weibo_search").addClass("imply_color").removeClass("none")});$("#weibo_search_btn").click(function(m){m.preventDefault();weiboSearhPage=1;userSearchPage=1;tuserSearchPage=1;tweibosearchPage=1;$(".loadmore").remove();var n=$("#keywords").val();var l=$("#weibo_search_btn").text();var k;var j;if(l==="搜索用户"){if(0==vtabIndex){k=weibo_url;j={operation:"user_search",keywords:n,page:userSearchPage}}else{k=tweibo_url;j={operation:"list_user",keywords:n,page:tuserSearchPage}}}else{if(0==vtabIndex){k=weibo_url;j={operation:"weibo_search",keywords:n,page:weiboSearhPage}}else{k=tweibo_url;j={operation:"weibo_search",keywords:n,page:tweibosearchPage}}}$.ajax({type:"GET",url:k,data:j,beforeSend:function(){var o=$("<span class='loading_wrapper'><img src='../img/loading.gif' /></span>");$("#source_list").html(o)},success:function(o){$("#source_list").html(o);if(0==vtabIndex){show_weibo_card("source_list")}}})});$("#douban_search_btn").click(function(n){n.preventDefault();var k=b.tabs("option","selected");var l=douban_url;var m=$("#d_keywords").val();var j;switch(k){case 0:j={operation:"book",keywords:m,startIndex:bookStartIndex,numResults:doubanItemCounts};break;case 1:j={operation:"movie",keywords:m,startIndex:movieStartIndex,numResults:doubanItemCounts};break;case 2:j={operation:"music",keywords:m,startIndex:musicStartIndex,numResults:doubanItemCounts};break;case 3:j={operation:"event",keywords:m,startIndex:eventStartIndex,numResults:doubanItemCounts};break;default:break}$.ajax({type:"GET",url:l,data:j,beforeSend:function(){var o=$("<span class='loading_wrapper'><img src='../img/loading.gif' /></span>");$("#source_list").html(o)},success:function(o){$("#source_list").html(o)}})});$("#search_tab_pic").click(function(){picSearchPage=1;$("#source_list").children().remove();$("#pic_keywords").val("关键字").addClass("imply_color")});$("#user_tab_pic").click(function(){userpicSearchPage=1;$("#source_list").children().remove();$("#pic_keywords").val("又拍用户名，注意不是昵称").addClass("imply_color")});$("#collect_tab_pic").click(function(){colSearchPage=1;$("#source_list").children().remove();$("#pic_keywords").val("又拍用户名，注意不是昵称").addClass("imply_color")});$("#recom_tab_pic").click(function(){recSearchPage=1;$("#source_list").children().remove();$("#pic_keywords").val("可指定日期如2010-6,默认搜索全部").addClass("imply_color")});$("#pic_search_btn").click(function(m){m.preventDefault();$(".loadmore").remove();var n=$("#pic_keywords").val();var l=i.tabs("option","selected");var k=yupoo_url;var j;if(0==l){j={operation:"pic_search",keywords:n,page:picSearchPage}}else{if(1==l){if($("#user_tab_pic").hasClass("yupoo_disable")){var o="<div class='bind_txt'><div class='imply_color'>用户搜索功能需要绑定又拍帐号</div><a href='/accounts/source'>马上绑定</a></div>";$("#source_list").html(o);return false}j={operation:"user_search",keywords:n,page:userpicSearchPage}}else{if(2==l){j={operation:"col_search",keywords:n,page:colSearchPage}}else{if(3==l){j={operation:"rec_search",keywords:n,page:recSearchPage}}}}}$.ajax({type:"GET",url:k,data:j,beforeSend:function(){var p=$("<span class='loading_wrapper'><img src='../img/loading.gif' /></span>");$("#source_list").html(p)},success:function(p){$("#source_list").html(p)}})});$("#source_list, #story_list").sortable({connectWith:".connectedSortable",cancel:".weibo_drop, .douban_drop, .img_upload_drop, .video_drop, .addTextElementAnchor, .textElement, .tuser, .loadmore, .ht_wrapper, .bind_txt",receive:function(P,U){var D=U.item;var E=("<li class='addTextElementAnchor'><span><a class='add_comment'></a></span></li>");var N=D.prev("li");var Z=D.next("li");if(!N.hasClass("addTextElementAnchor")){D.before(E)}if(!Z.hasClass("addTextElementAnchor")){D.after(E)}var L=$("#story_list li:not(.addTextElementAnchor, .textElement, .video_drop)");if(D.hasClass("weibo_drag")){var R="";var B="";var x=D.find(".user_page").attr("href");var ag=D.find(".weibo_text").html();var Y=D.find(".weibo_from").text();var z=D.find(".create_time").text();var aa=D.find(".profile_img").attr("src");var t;if(D.hasClass("sina")){if(D.find(".weibo_img img").length!=0){var u=D.find(".weibo_img img").attr("src").replace(/thumbnail/,"bmiddle");R="<div class='weibo_img_drop'><img src='"+u+"' /></div>"}if(D.find(".weibo_retweet_img img").length!=0){var ae=D.find(".weibo_retweet_img img").attr("src").replace(/thumbnail/,"bmiddle");B="<div class='weibo_retweet_img_drop'><img src='"+ae+"' /></div>"}D.removeClass("weibo_drag").addClass("weibo_drop sina").children().remove();t=("<div class='cross' action='delete'></div><div class='handle'></div><div class='story_wrapper'><div class='content_wrapper'><span class='weibo_text_drop'>"+ag+"</span>"+B+R+"</div><div class='story_signature'><span class='float_r'><a href='"+x+"' target='_blank'><img class='profile_img_drop' src='"+aa+"' alt='"+Y+"' border=0 /></a></span><div class='signature_text_drop'><div class='text_wrapper'><span><a class='weibo_from_drop' href='"+x+"' target='_blank'>"+Y+"</a></span></div><div class='weibo_date_drop'>"+z+"</div></div></div></div>");if(D.index(L)==0){$("#story_thumbnail").attr("src",aa.replace(/(\d+)\/50\/(\d+)/,"$1/180/$2"))}}else{if(D.find(".weibo_img img").length!=0){var u=D.find(".weibo_img img").attr("src").replace(/120$/,"240");R="<div class='weibo_img_drop'><img src='"+u+"' /></div>"}if(D.find(".weibo_retweet_img img").length!=0){var ae=D.find(".weibo_retweet_img img").attr("src").replace(/120$/,"240");B="<div class='weibo_retweet_img_drop'><img src='"+ae+"' /></div>"}D.removeClass("weibo_drag").addClass("weibo_drop tencent").children().remove();t=("<div class='cross' action='delete'></div><div class='handle'></div><div class='story_wrapper'><div class='content_wrapper'><span class='weibo_text_drop'>"+ag+"</span>"+B+R+"</div><div class='story_signature'><span class='float_r'><a href='"+x+"' target='_blank'><img class='profile_img_drop' src='"+aa+"' alt='"+Y+"' border=0 /></a></span><div class='signature_text_drop'><div class='text_wrapper'><span ><a class='weibo_from_drop' href='"+x+"' target='_blank'>"+Y+"</a></span></div><div class='weibo_date_drop'>"+z+"</div></div></div></div>");if(D.index(L)==0){$("#story_thumbnail").attr("src",aa.replace(/50$/,"180"))}}D.append(t);if(0==vtabIndex){show_weibo_card(D.attr("id"))}}else{if(D.hasClass("douban_drag")){var G="",o=D.find(".profile_img").attr("src"),F=D.find(".profile_img").attr("title"),k=D.find(".douban_from").attr("href");if(D.hasClass("event")){var q=D.find(".event_title a").text(),l=D.find(".event_summary").text(),ah=D.find(".event_initiator a").text(),p=D.find(".event_initiator a").attr("href"),ad=D.find(".start_time").text(),j=D.find(".end_time").text(),I=D.find(".event_title a").attr("href"),w=D.find(".event_img_wrapper img").attr("src"),W=D.find(".event_location").text(),T=D.find(".event_city").text();G=("<div class='cross' action='delete'></div><div class='handle'></div><div class='douban_wrapper'><div class='content_wrapper'><div class='event_summary_drop'>"+l+"</div><div class='event_wrapper'><a href='"+I+"' target='_blank'><img class='item_img_drop float_l' src='"+w+"' /></a><div class='item_meta_drop'><div class='event_title_drop'>活动：<a href='"+I+"' target='_blank'>"+q+"</a></div><div class='event_initiator_drop'>发起人：<a href='"+p+"' target='_blank'>"+ah+"</a></div><div class='start_time_drop'>"+ad+"</div><div class='end_time_drop'>"+j+"</div><div class='event_city_drop'>"+T+"</div><div class='event_location_drop'>"+W+"</div></div></div></div><div class='douban_signature'><span class='float_r'><a href='"+k+"' target='_blank'><img class='profile_img_drop' src='"+o+"' alt='"+F+"' border=0 /></a></span><span class='signature_text_drop'><div class='text_wrapper'><span ><a class='douban_from_drop' href='"+k+"' target='_blank'>"+F+"</a></span></div><div class='douban_date_drop'></div></span> </div></div>");D.removeClass("douban_drag").addClass("douban_drop").children().remove();if(D.index(L)==0){$("#story_thumbnail").attr("src",o)}D.append(G)}else{if(D.hasClass("bookReviews")||D.hasClass("movieReviews")||D.hasClass("musicReviews")){var A=D.find(".item_title").attr("href"),s=D.find(".comment_title").text(),aj=D.find(".comment_summary").html(),V=D.find(".comment_date").text(),Q=D.find(".item_img").attr("src"),y=D.find(".item_title").text(),S=D.find(".item_author").text(),v=D.find(".item_date").text(),al=D.find(".average_rating").text(),r=D.find(".item_rating").text();G=("<div class='cross' action='delete'></div><div class='handle'></div><div class='douban_wrapper'><div class='content_wrapper'><div><div class='comment_title_drop'>"+s+"</div><div class='comment_summary_drop'>"+aj+"</div></div><div class='item_info_drop'><a href='"+A+"' target='_blank'><img class='item_img_drop float_l' src='"+Q+"' /></a><div class='item_meta_drop'><div><a class='item_title_drop' href='"+A+"' target='_blank'>"+y+"</a></div><div class='item_author_drop'>"+S+"</div><div class='item_date_drop'>"+v+"</div><div class=item_rating_drop>"+r+"</div><div class='average_rating_drop'>"+al+"</div></div></div></div><div class='douban_signature'><span class='float_r'><a href='"+k+"' target='_blank'><img class='profile_img_drop' src='"+o+"' alt='"+F+"' border=0 /></a></span><span class='signature_text_drop'><div class='text_wrapper'><span ><a class='douban_from_drop' href='"+k+"' target='_blank'>"+F+"</a></span></div><div class='douban_date_drop'>"+V+"</div></span> </div></div>");D.removeClass("douban_drag").addClass("douban_drop").children().remove();if(D.index(L)==0){$("#story_thumbnail").attr("src",o)}D.append(G)}else{if(D.index(L)==0){$("#story_thumbnail").attr("src",D.find(".item_img").attr("src"))}D.removeClass("douban_drag").addClass("douban_drop");D.find(".douban_flag").removeClass().addClass("content_wrapper");D.find(".douban_review").closest("div").remove();D.prepend("<div class='cross' action='delete'></div><div class='handle'></div>")}}}else{if(D.hasClass("img_upload_drag")){var X=D.find("img").attr("src"),J=("<div class='cross' action='delete'></div><div class='handle'></div><div class='img_wrapper'><img src='"+X+"'></div>");if(D.index(L)==0){$("#story_thumbnail").attr("src",D.find("img").attr("src"))}D.removeClass("img_upload_drag").addClass("img_upload_drop").children().remove();D.append(J)}else{if(D.hasClass("video_drag")){var ai=D.find(".videoTitle a"),ac=ai.attr("href"),ak=ai.text();var m=("<div class='cross' action='delete'></div><div class='handle'></div><div class='youku_wrapper'><div><a class='videoTitle' target='_blank' href='"+ac+"'>"+ak+"</a></div><div class='embed'>"+embedCode+"</div></div>");D.removeClass("video_drag").addClass("video_drop").children().remove();D.append(m)}else{if(D.hasClass("pic_drag")){var M=D.find("img").attr("src"),K=D.find(".pic_title").text(),C=D.find(".pic_title").attr("href"),ab=D.find(".pic_author").text(),H=D.find(".pic_author").attr("href"),n=M.split("/"),O=n.length;n[O-1]="small";M=n.join("/");var af=("<div class='cross' action='delete'></div><div class='handle'></div><div class='yupoo_wrapper'><a target='_blank' href='"+C+"'><img class='pic_img' src='"+M+"'/></a><div><a class='pic_title' target='_blank' href='"+C+"'>"+K+"</a></div><div><a class='pic_author' target='_blank' href='"+H+"'>"+ab+"</a></div><div class='yupoo_sign'></div></div>");D.removeClass("pic_drag").addClass("pic_drop").children().remove();D.append(af);if(D.index(L)==0){$("#story_thumbnail").attr("src",M.replace(/small$/,"square"))}}}}}}}});$("#embedVideo").click(function(n){n.preventDefault();var j=$("<span class='loading_wrapper'><img src='../img/loading.gif' /></span>");$("#source_list").html(j);var r,s="<div class='bind_txt'><div class='imply_color center'>请检查输入的视频链接是否可以正常访问或再试一次</div></div>",k=$("#videoUrl"),q=k.val(),l={url:q},o="/member/embedVideo.php",m=new RegExp("youku.com/"),p=m.test(q);if(k.hasClass("imply_color")||!p){r=s;$("#source_list").html(r);return false}$.get(o,l,function(v,y){if(y=="success"){if(v.errorcode==0){embedCode=v.embedcode;var w=v.title,t=v.desc,u=v.host+".com",x=v.img;if(typeof t==="undefined"){t=""}r="<li class='video_drag'><div class='videoTitle'><a target='_blank' href='"+q+"'>"+w+"</a></div><div class='videoContent'><img class='video_thumbnail' src='"+x+"' /><div class='video_wrapper'><div class='video_domain'><a target='_blank' href='"+q+"'>"+u+"</a></div><div class='video_description'>"+t+"</div></div></div></li>"}else{r=s}$("#source_list").html(r)}},"json")});if($("#sto_title").val()==""){$("#sto_title").val("你的故事标题").removeClass("imply_color").focus(function(){if($(this).val()=="你的故事标题"){$(this).val("").removeClass("imply_color")}}).blur(function(){if($(this).val()==""){$(this).val("你的故事标题").removeClass("imply_color")}})}if($("#sto_summary").val()==""){$("#sto_summary").val("给你的故事写一个简短的描述").addClass("imply_color").focus(function(){if($(this).val()=="给你的故事写一个简短的描述"){$(this).val("").removeClass("imply_color")}}).blur(function(){if($(this).val()==""){$(this).val("给你的故事写一个简短的描述").addClass("imply_color")}})}if($("#sto_tag").val()==""){$("#sto_tag").val("添加故事标签，空格或逗号分隔").addClass("imply_color").focus(function(){if($(this).val()=="添加故事标签，空格或逗号分隔"){$(this).val("").removeClass("imply_color")}}).blur(function(){if($(this).val()==""){$(this).val("添加故事标签，空格或逗号分隔").addClass("imply_color")}})}$("#story_list li").live("mouseover",function(j){$(this).find(".cross").css("visibility","visible")});$("#story_list li").live("mouseout",function(j){$(this).find(".cross").css("visibility","hidden")});$("#actions").click(function(q){q.preventDefault();var s=$(q.target);unbindonbeforeunload();if(s.hasClass("disable")){var m=$(window).height(),u=$(window).width(),k=$(document).scrollTop(),l=$(document).scrollLeft(),t=$("#boxes #dialog");t.css("top",m/2-t.height()/2+k-100);t.css("left",u/2-t.width()/2+l);t.fadeIn(1000)}else{var n=$("#sto_title").attr("value");var v;var p="/member/publish.php";if(s.is("#publishBtn")){v=prepare_story_data("Publish")}else{if(s.is("#previewBtn")){v=prepare_story_data("Preview")}else{if(s.is("#draftBtn")){v=prepare_story_data("Draft")}else{var j=confirm("确定放弃吗? 您本次做的更改不会保存。");if(j==true){if(s.hasClass("login_flag")){var o=s.closest("span").attr("id").substr(5);self.location="/user/"+o;return false}else{self.location="/";return false}}}}}if(s.is("#publishBtn")&&n=="你的故事标题"){alert("请为你的故事输入一个标题");$("#sto_title").focus()}else{$.post(p,v,function(r,w){self.location=r})}}});$(".douban_review").live("click",function(l){l.preventDefault();var k=douban_rurl;var j;var m=$(this).closest(".douban_drag").attr("id").substr(2);if($(this).hasClass("book")){j={operation:"bookReviews",subjectID:m,startIndex:bookReviewStartIndex,numResults:commentsPerQuery}}else{if($(this).hasClass("movie")){j={operation:"movieReviews",subjectID:m,startIndex:movieReviewStartIndex,numResults:commentsPerQuery}}else{if($(this).hasClass("music")){j={operation:"musicReviews",subjectID:m,startIndex:musicReviewStartIndex,numResults:commentsPerQuery}}}}$.ajax({type:"GET",url:k,data:j,beforeSend:function(){var n=$("<span class='loading_wrapper'><img src='../img/loading.gif' /></span>");$("#source_list").html(n)},success:function(n){$("#source_list").html(n)}})});$(".list_tweibo").live("click",function(m){usersearchTimestamp=0;m.preventDefault();var k=tweibo_url;var j;var l=$(this).closest(".weibo_drag").attr("id");j={operation:"user_search",keywords:l,page:0,timestamp:usersearchTimestamp};$.ajax({type:"GET",url:k,data:j,beforeSend:function(){var n=$("<span class='loading_wrapper'><img src='../img/loading.gif' /></span>");$("#source_list").html(n)},success:function(n){$("#source_list").html(n)}})});$(".list_t_weibo").live("click",function(l){l.preventDefault();weiboSearhPage=1;var k=weibo_url;var j;var m=$(this).text();j={operation:"weibo_search",keywords:m,page:weiboSearhPage};$.ajax({type:"GET",url:k,data:j,beforeSend:function(){var n=$("<span class='loading_wrapper'><img src='../img/loading.gif' /></span>");$("#source_list").html(n)},success:function(n){$("#source_list").html(n);show_weibo_card("source_list")}})});$("#source_list").click(function(o){var m;if(0==vtabIndex||1==vtabIndex){m=f.tabs("option","selected")}else{if(2==vtabIndex){m=b.tabs("option","selected")}else{if(4==vtabIndex){m=i.tabs("option","selected")}}}if($(o.target).is(".loadmore")){var l;var j;if(0==m){var p;if(0==vtabIndex){p=$("#keywords").val();l=weibo_url;weiboSearhPage++;j={operation:"weibo_search",keywords:p,page:weiboSearhPage}}else{if(1==vtabIndex){p=$("#keywords").val();l=tweibo_url;tweibosearchPage++;j={operation:"weibo_search",keywords:p,page:tweibosearchPage}}else{if(2==vtabIndex){var k=$(".loadmore");if(k.hasClass("book")){l=douban_url;bookStartIndex=bookStartIndex+doubanItemCounts;j={operation:"book",keywords:$("#d_keywords").val(),startIndex:bookStartIndex,numResults:doubanItemCounts}}else{if(k.hasClass("bookReviews")){l=douban_rurl;bookReviewStartIndex=bookReviewStartIndex+commentsPerQuery;j={operation:"bookReviews",subjectID:k.attr("id"),startIndex:bookReviewStartIndex,numResults:commentsPerQuery}}}}else{if(4==vtabIndex){p=$("#pic_keywords").val();l=yupoo_url;picSearchPage++;j={operation:"pic_search",keywords:p,page:picSearchPage}}}}}$(".loadmore").remove();$.get(l,j,function(q,r){$("#source_list").append(q);if(0==vtabIndex){show_weibo_card("source_list")}})}else{if(1==m){if(0==vtabIndex){l=weibo_url;userSearchPage++;j={operation:"user_search",keywords:$("#keywords").val(),page:userSearchPage}}else{if(1==vtabIndex){l=tweibo_url;if($(o.target).closest(".loadmore").hasClass("tuser")){tuserSearchPage++;j={operation:"list_user",keywords:$("#keywords").val(),page:tuserSearchPage}}else{var n=$(".loadmore").prev().find(".user_page").attr("href").replace(/http:\/\/t.qq.com\//,"");usersearchTimestamp=$(".loadmore span").attr("id");j={operation:"user_search",keywords:n,page:1,timestamp:usersearchTimestamp}}}else{if(2==vtabIndex){var k=$(".loadmore");if(k.hasClass("movie")){l=douban_url;movieStartIndex=movieStartIndex+doubanItemCounts;j={operation:"movie",keywords:$("#d_keywords").val(),startIndex:movieStartIndex,numResults:doubanItemCounts}}else{if(k.hasClass("movieReviews")){l=douban_rurl;movieReviewStartIndex=movieReviewStartIndex+commentsPerQuery;j={operation:"movieReviews",subjectID:k.attr("id"),startIndex:movieReviewStartIndex,numResults:commentsPerQuery}}}}else{if(4==vtabIndex){p=$("#pic_keywords").val();l=yupoo_url;userpicSearchPage++;j={operation:"user_search",keywords:p,page:userpicSearchPage}}}}}$(".loadmore").remove();$.get(l,j,function(q,r){$("#source_list").append(q);if(0==vtabIndex){show_weibo_card("source_list")}})}else{if(2==m){if(0==vtabIndex){l=weibo_url;myPage++;j={operation:"my_weibo",page:myPage}}else{if(1==vtabIndex){l=tweibo_url;myPageTimestamp=$(".loadmore span").attr("id");j={operation:"my_weibo",page:1,timestamp:myPageTimestamp}}else{if(2==vtabIndex){var k=$(".loadmore");if(k.hasClass("music")){l=douban_url;musicStartIndex=musicStartIndex+doubanItemCounts;j={operation:"music",keywords:$("#d_keywords").val(),startIndex:musicStartIndex,numResults:doubanItemCounts}}else{if(k.hasClass("musicReviews")){l=douban_rurl;musicReviewStartIndex=musicReviewStartIndex+commentsPerQuery;j={operation:"musicReviews",subjectID:k.attr("id"),startIndex:musicReviewStartIndex,numResults:commentsPerQuery}}}}else{if(4==vtabIndex){p=$("#pic_keywords").val();l=yupoo_url;colSearchPage++;j={operation:"col_search",keywords:p,page:colSearchPage}}}}}$(".loadmore").remove();$.get(l,j,function(q,r){$("#source_list").append(q);if(0==vtabIndex){show_weibo_card("source_list")}})}else{if(3==m){if(0==vtabIndex){l=weibo_url;followPage++;j={operation:"my_follow",page:followPage}}else{if(1==vtabIndex){l=tweibo_url;followTimestamp=$(".loadmore span").attr("id");j={operation:"my_follow",page:1,timestamp:followTimestamp}}else{if(2==vtabIndex){l=douban_url;eventStartIndex=eventStartIndex+doubanItemCounts;j={operation:"event",keywords:$("#d_keywords").val(),startIndex:eventStartIndex,numResults:doubanItemCounts}}else{if(4==vtabIndex){p=$("#pic_keywords").val();l=yupoo_url;recSearchPage++;j={operation:"rec_search",keywords:p,page:recSearchPage}}}}}$(".loadmore").remove();$.get(l,j,function(q,r){$("#source_list").append(q);if(0==vtabIndex){show_weibo_card("source_list")}})}else{if(0==vtabIndex){l=weibo_url;favPage++;j={operation:"my_fav",page:favPage}}else{if(1==vtabIndex){l=tweibo_url;favTimestamp=$(".loadmore span").attr("id");j={operation:"my_fav",page:1,timestamp:favTimestamp}}}$(".loadmore").remove();$.get(l,j,function(q,r){$("#source_list").append(q);if(0==vtabIndex){show_weibo_card("source_list")}})}}}}}});$(".addTextElementAnchor").live("mouseenter",function(){$(this).css("background-color","#FDFFD2").append('<span class="add_text">点击添加文字</span>')}).live("mouseleave",function(){$(this).css("background-color","#FFFFFF").find(".add_text").remove()});$("#story_list").click(function(n){if($(n.target).is(".add_comment")||$(n.target).is(".add_text")||$(n.target).is(".addTextElementAnchor")){n.preventDefault();var k=$("<li class='textElement editing'><div class='editingDiv'><form class='formTextElement'><textarea class='inputEditor' name='inputEditor'></textarea></form><div class='belowTextEdit'><div class='actions'><button class='submit submitComment' type='submit'>确定</button><button class='cancel cancelEditor' type='reset'>取消</button></div></div></div></li><li class='addTextElementAnchor'><span><a class='add_comment'></a></span></li>");$(n.target).closest("li").after(k);$(".inputEditor").cleditor({width:476,height:150,controls:"bold italic underline strikethrough | font size removeformat | bullets numbering | alignleft center alignright | undo redo | link unlink"})}if($(n.target).is(".cancelEditor")){n.preventDefault();$(n.target).closest(".textElement").next(".addTextElementAnchor").remove();$(n.target).closest(".textElement").remove()}if($(n.target).is(".submitComment")){n.preventDefault();var m=$(n.target).closest(".textElement"),o=m.find(".inputEditor").val(),j=o.replace(/(\&nbsp;|\<br\>)/g,"");j=$.trim(j);if(j==""){$(n.target).closest(".textElement").next(".addTextElementAnchor").remove();$(n.target).closest(".textElement").remove()}else{$(n.target).closest(".editingDiv").remove();var l=$("<div class='cross' action='delete'></div><div class='handle'></div><div class='commentBox'>"+o+"</div>");m.removeClass("editing").addClass("editted").append(l)}}});$(".add_fav").live("click",function(m){m.preventDefault();var l=$(this),n=l.closest("li"),k=n.attr("id").substr(2),j={operation:"add_fav",id:k};if(n.hasClass("sina")){postUrl="/weibo/postweibo.php"}else{postUrl="/tweibo/posttweibo.php"}$.post(postUrl,j,function(o,p){if(p=="success"){l.text("[取消收藏]");l.removeClass().addClass("del_fav")}})});$(".del_fav").live("click",function(m){m.preventDefault();var l=$(this),n=l.closest("li"),k=n.attr("id").substr(2),j={operation:"del_fav",id:k};if(n.hasClass("sina")){postUrl="/weibo/postweibo.php"}else{postUrl="/tweibo/posttweibo.php"}$.post(postUrl,j,function(o,p){if(p=="success"){if(l.hasClass("remove_flag")){n.hide("slow",function(){n.remove()})}else{l.text("[收藏]");l.removeClass().addClass("add_fav")}}})});var d=$("#upload_btn"),a;if(d.length){new AjaxUpload(d,{action:"/member/imgupload.php",name:"photofile",onSubmit:function(j,k){k=k.toLowerCase();if(k&&/^(jpg|png|jpeg|gif|bmp)$/.test(k)){d.text("正在上传");this.disable();a=window.setInterval(function(){var l=d.text();if(l.length<13){d.text(l+".")}else{d.text("正在上传")}},200)}else{$('<div class="imply_color center">不支持该文件类型</div>').appendTo("#source_list");return false}},onComplete:function(k,j){d.text("添加照片");window.clearInterval(a);this.enable();$("#source_list .imply_color").remove();$("#source_list").append(j)}})}var e=$("#vtab>ul>li");var g=0;e.click(function(){e.removeClass("selected");$(this).addClass("selected");vtabIndex=e.index($(this));switch(vtabIndex){case 0:$("#search_tab").text("话题搜索");$("#my_tab").text("我的微博");$("#follow_tab").text("我的关注");$("#weibo_search_btn").text("搜索话题");if(0!=g){f.tabs("select",0);$("#weibo_search").removeClass("none");$("#source_list").children().remove();if($("#keywords").hasClass("imply_color")){$("#keywords").val("关键字")}var k=weibo_url;var j;j={operation:"list_ht"};$.ajax({type:"GET",url:k,data:j,beforeSend:function(){var l=$("<span class='loading_wrapper'><img src='../img/loading.gif' /></span>");$("#source_list").html(l)},success:function(l){$("#source_list").html(l)}})}g=0;$("#vtab>div").hide().eq(vtabIndex).show();break;case 1:$("#search_tab").text("微博搜索");$("#my_tab").text("我的广播");$("#follow_tab").text("我的收听");$("#weibo_search_btn").text("搜索微博");if(1!=g){f.tabs("select",0);$("#weibo_search").removeClass("none");$("#source_list").children().remove();if($("#keywords").hasClass("imply_color")){$("#keywords").val("关键字")}}g=1;$("#vtab>div").hide().eq(vtabIndex-1).show();break;case 2:if(2!=g){b.tabs("select",0);$("#source_list").children().remove();if($("#d_keywords").hasClass("imply_color")){$("#d_keywords").val("书名")}}g=2;$("#vtab>div").hide().eq(vtabIndex-1).show();break;case 3:if(3!=g){$("#source_list").children().remove()}g=3;$("#vtab>div").hide().eq(vtabIndex-1).show();break;case 4:if(4!=g){i.tabs("select",0);$("#source_list").children().remove();$("#pic_keywords").val("关键字").addClass("imply_color")}g=4;$("#vtab>div").hide().eq(vtabIndex-1).show();break;case 5:if(5!=g){$("#source_list").children().remove()}g=5;$("#vtab>div").hide().eq(vtabIndex-1).show();break}}).eq(0).click();$(".window .close").click(function(j){j.preventDefault();$("#mask").hide();$(".window").hide()});$("#mask").click(function(){$(this).hide();$(".window").hide()})});