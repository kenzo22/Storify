var embedCode,vtabIndex,followPage,myPage,favPage,userSearchPage,tuserSearchPage,myPageTimestamp,followTimestamp,favTimestamp,usersearchTimestamp;var weiboSearhPage=1,picSearchPage=1,userpicSearchPage=1,colSearchPage=1,recSearchPage=1,tweibosearchPage=1,doubanItemCounts=10,commentsPerQuery=5,eventStartIndex=1,bookStartIndex=1,bookReviewStartIndex=1,movieStartIndex=1,movieReviewStartIndex=1,musicStartIndex=1,musicReviewStartIndex=1,weibo_url="/weibo/weibooperation.php",tweibo_url="/tweibo/tweibooperation.php",douban_url="/douban/doubanoperation.php",douban_rurl="/douban/doubanreviewsoperation.php",yupoo_url="/yupoo/yupoooperation.php",sum_txt="给你的故事写一个简短的描述",tags_txt="添加故事标签，空格或逗号分隔";if(typeof(window.innerHeight)=="number"){myHeight=window.innerHeight}else{if(document.documentElement&&document.documentElement.clientHeight){myHeight=document.documentElement.clientHeight}}var l_used_height=267,r_user_height=326,height_adjust=3,l_list_height=myHeight-l_used_height,r_list_height;var browser_info=$.browser;if(browser_info.mozilla){r_list_height=myHeight-r_user_height}else{if(browser_info.webkit){r_list_height=myHeight-r_user_height-height_adjust}else{if(browser_info.msie){r_list_height=myHeight-r_user_height+height_adjust}}}Array.prototype.getUnique=function(){var f={},c,d;for(c=0;d=this[c];c++){f[d]=1}var b=new Array();for(d in f){b.push(d)}return b};String.prototype.len=function(){return this.replace(/[^\x00-\xff]/g,"**").length};function bindonbeforeunload(){window.onbeforeunload=popalert}function unbindonbeforeunload(){window.onbeforeunload=null}function popalert(){return"本页面要求您确认您要离开 - 您输入的数据可能不会被保存"}function createCookie(c,d,e){if(e){var b=new Date();b.setTime(b.getTime()+(e*24*60*60*1000));var a="; expires="+b.toGMTString()}else{var a=""}document.cookie=c+"="+d+a+"; path=/"}function readCookie(b){var e=b+"=";var a=document.cookie.split(";");for(var d=0;d<a.length;d++){var f=a[d];while(f.charAt(0)==" "){f=f.substring(1,f.length)}if(f.indexOf(e)==0){return f.substring(e.length,f.length)}}return null}function eraseCookie(a){createCookie(a,"",-1)}function show_weibo_card(a){WB2.anyWhere(function(b){b.widget.hoverCard({id:a,search:true})})}function prepare_story_data(k){if(k!="Publish"&&k!="Preview"&&k!="Draft"){alert("not a proper operation:"+k)}var a;if(typeof(post_id)=="undefined"||post_id==null){a=0}else{a=post_id}var j=new Object;j.content=[];$("#story_list li:not(.addTextElementAnchor)").each(function(N){j.content[N]={};j.content[N].id=N;if($(this).hasClass("sina")){j.content[N].type="weibo";var B=$(this).attr("id").substr(2),v=$(this).find(".weibo_from_drop").text(),q=$(this).find(".weibo_from_drop").attr("href").replace(/http:\/\/weibo.com\//,""),I={id:B,nic:v,uid:q};j.content[N].content=I}else{if($(this).hasClass("tencent")){j.content[N].type="tweibo";var O=$(this).attr("id").substr(2),M=$(this).find(".weibo_from_drop").text(),G=$(this).find(".weibo_from_drop").attr("href").replace(/http:\/\/t.qq.com\//,""),R={id:O,nic:M,name:G};j.content[N].content=R}else{if($(this).hasClass("img_upload_drop")){j.content[N].type="upload_img";j.content[N].content=$(this).find("img").attr("src")}else{if($(this).hasClass("textElement")){if($(this).hasClass("editing")){var r=$(this).find(".inputEditor").val();temp=r.replace(/(\&nbsp;|\<br\>)/g,"");temp=$.trim(temp);if(!(temp=="")){j.content[N].type="comment";j.content[N].content=r}}else{j.content[N].type="comment";j.content[N].content=$(this).find(".commentBox").html()}}else{if($(this).hasClass("douban")){var J=$(this).attr("class"),y=J.split(" "),D=y.length,K;for(K=0;K<D;K++){if(y[K]!="douban"&&y[K]!="douban_drop"){break}}var t=y[K];j.content[N].type="douban";var x=$(this).attr("id").substr(2),s={item_type:t,item_id:x};j.content[N].content=s}else{if($(this).hasClass("video_drop")){j.content[N].type="video";var C=$(this).find(".videoTitle").text(),p=$(this).find("embed").attr("src"),Q=$(this).find(".videoTitle").attr("href"),A={title:C,src:p,url:Q};j.content[N].content=A}else{if($(this).hasClass("pic_drop")){j.content[N].type="photo";var L=$(this).find(".pic_title").text(),z=$(this).find(".pic_author").attr("href").replace(/http:\/\/www.yupoo.com\/photos\//,""),w=$(this).find(".pic_author").text(),u=$(this).find(".pic_title").attr("href"),E=u.split("/"),P=E.length,F=E[P-1],H=$(this).find(".pic_img").attr("src"),o={id:F,title:L,author:z,nic:w,url:H};j.content[N].content=o}}}}}}}});var h=JSON.stringify(j),b=$("#sto_title"),l=$("#sto_summary"),c=$("#sto_tag"),d=b.attr("value"),e=l.val(),g=(l.hasClass("imply_color")?"":e),i=c.attr("value"),m=(c.hasClass("imply_color")?"":i),f=$("#story_thumbnail").attr("src"),n={story_id:a,story_title:d,story_summary:g,story_pic:f,story_tag:m,story_content:h,action:k};return n}function remove_item(b){var g=$(b.target||b.srcElement).closest("li"),f=true,d=g.hasClass("img_upload_drag");if(g.hasClass("img_upload_drop")||d){var c=true,e=g.find("img").attr("src").substr(12)}if(g.hasClass("video_drag")||d){f=false}if(f){g.next("li").remove()}g.hide("slow",function(){g.remove()});if(c){var h=$("#story_thumbnail");if(("/img/upload/"+e)==h.attr("src")){h.attr("src","/img/story_dft.jpg")}var a={file:e};$.post("/member/imgdelete.php",a)}}function change_story_pic(f){var e,a=[],d=a.length;$("#story_list img").each(function(h){e=$(this).attr("src");if(e!=""){if($(this).hasClass("profile_img_drop")){if($(this).closest("li").hasClass("sina")){e=e.replace(/(\d+)\/50\/(\d+)/,"$1/180/$2")}else{if($(this).closest("li").hasClass("tencent")){e=e.replace(/50$/,"180")}}}a[d]=e;d++}});a=a.getUnique();var c,g=a.length,b=$("#story_thumbnail").attr("src");for(c=0;c<g;c++){if(a[c]===b){break}}if(c==g){c=0}else{if(f=="next"){c=c+1;if(c==g){c=0}}else{if(f=="prev"){c=c-1;if(c<0){c=g-1}}}}$("#story_thumbnail").attr("src",a[c])}$(function(){$("#source_list").css("height",l_list_height);$("#story_list").css("min-height",r_list_height);var h=$("#weiboTabs").tabs(),d=$("#doubanTabs").tabs(),k=$("#picTabs").tabs(),l=!$("#my_tab").hasClass("sina_disable"),m=!$("#my_tab").hasClass("tencent_disable");if(null==readCookie("editortip")){var j="<div id='first_tip' class='tip_container'><div class='tip_arrow top'></div><div class='tip_wrapper'><strong>小贴士1/4: 开始创建</strong><br>输入故事标题，描述，标签<br>左右箭头可以用来选择故事的封面<div class='tip_actions'><a class='tip_hide' href='#'>隐藏</a><a class='tip_next' href='#'>下一条 &raquo;</a></div></div></div>";$("#storyContent .inner").prepend(j);createCookie("editortip","tippopflag",365)}$("#first_tip .tip_next").live("click",function(){$("#first_tip").remove();var n="<div id='second_tip' class='tip_container'><div class='tip_arrow left'></div><div class='tip_wrapper'><strong>小贴士2/4: 寻找素材</strong><br>切换信息源来寻找喜欢的素材<div class='tip_actions'><a class='tip_hide' href='#'>隐藏</a><a class='tip_next' href='#'>下一条 &raquo;</a></div></div></div>";$("#storyContent .inner").prepend(n)});$("#second_tip .tip_next").live("click",function(){$("#second_tip").remove();var n="<div id='third_tip' class='tip_container'><div class='tip_arrow left'></div><div class='tip_arrow right'></div><div class='tip_wrapper'><strong>小贴士3/4: 组织素材</strong><br>将喜欢的素材从左栏拖放到右栏<br>别忘了可以选择放置的位置<div class='tip_actions'><a class='tip_hide' href='#'>隐藏</a><a class='tip_next' href='#'>下一条 &raquo;</a></div></div></div>";$("#storyContent .inner").prepend(n)});$("#third_tip .tip_next").live("click",function(){$("#third_tip").remove();var n="<div id='fourth_tip' class='tip_container'><div class='tip_arrow top'></div><div class='tip_wrapper'><strong>小贴士4/4: 添加文字</strong><br>点击T图标给故事添加文字<div class='tip_actions'><a class='tip_hide' href='#'>隐藏</a></div></div></div>";$("#storyContent .inner").prepend(n)});$(".tip_container .tip_hide").live("click",function(){$(".tip_container").remove()});$("#keywords, #d_keywords, #videoUrl, #pic_keywords").bind("keyup",function(o){var n=o.keyCode||o.which;if(n==13){$(this).next().click()}});$("#connectBtn").live("click",function(n){n.preventDefault();$.post("/accounts/login/sina_auth.php",{},function(o,p){$("#dialog.window").hide();self.location=o})});$("#prev_img").click(function(n){n.preventDefault();change_story_pic("prev")});$("#next_img").click(function(n){n.preventDefault();change_story_pic("next")});$(".cross").live("click",function(n){n.preventDefault();remove_item(n)});show_weibo_card("story_list");$("#keywords").val("关键字").addClass("imply_color");$("#keywords").blur(function(){if($(this).val()==""){var n=h.tabs("option","selected");if(n==0){$(this).val("关键字").addClass("imply_color")}else{if(n==1){$(this).val("微博用户名").addClass("imply_color")}}}}).focus(function(){var n=h.tabs("option","selected");if((n==0&&$(this).val()=="关键字")||(n==1&&$(this).val()=="微博用户名")){$(this).val("").removeClass("imply_color")}});$("#d_keywords").val("书名").addClass("imply_color");$("#videoUrl").val("请输入视频播放页地址").addClass("imply_color");$("#videoUrl").blur(function(){if($(this).val()==""){$(this).val("请输入视频播放页地址").addClass("imply_color")}}).focus(function(){if($(this).val()=="请输入视频播放页地址"){$(this).val("").removeClass("imply_color")}});$("#book_tab").click(function(){bookStartIndex=1;if($("#d_keywords").hasClass("imply_color")){$("#d_keywords").val("书名")}$("#source_list").children().remove()});$("#movie_tab").click(function(){movieStartIndex=1;if($("#d_keywords").hasClass("imply_color")){$("#d_keywords").val("电影名")}$("#source_list").children().remove()});$("#music_tab").click(function(){musicStartIndex=1;if($("#d_keywords").hasClass("imply_color")){$("#d_keywords").val("歌曲名")}$("#source_list").children().remove()});$("#event_tab").click(function(n){eventStartIndex=1;if($("#d_keywords").hasClass("imply_color")){$("#d_keywords").val("搜活动")}$("#source_list").children().remove()});$("#d_keywords").blur(function(){if($(this).val()==""){$(this).addClass("imply_color");var n=d.tabs("option","selected");switch(n){case 0:$(this).val("书名");break;case 1:$(this).val("电影名");break;case 2:$(this).val("歌曲名");break;case 3:$(this).val("搜活动");break}}}).focus(function(){var o=d.tabs("option","selected");var n=$(this).val();if((o==0&&n=="书名")||(o==1&&n=="电影名")||(o==2&&n=="歌曲名")||(o==3&&n=="搜活动")){$(this).val("").removeClass("imply_color")}});$("#pic_keywords").val("关键字").addClass("imply_color");$("#pic_keywords").blur(function(){if($(this).val()==""){$(this).addClass("imply_color");var n=k.tabs("option","selected");if(n==0){$(this).val("关键字")}else{if(n==1||n==2){$(this).val("又拍用户名，注意不是昵称")}else{$(this).val("可指定日期如2010-6,默认搜索全部")}}}}).focus(function(){var n=k.tabs("option","selected");var o=$(this).val();if((n==0&&o=="关键字")||(n==1&&o=="又拍用户名，注意不是昵称")||(n==2&&o=="又拍用户名，注意不是昵称")||(n==3&&o=="可指定日期如2010-6,默认搜索全部")){$(this).val("").removeClass("imply_color")}});$("#my_tab").click(function(){$(".weibo_drag").remove();$(".loadmore").remove();$("#weibo_search").addClass("none");myPage=1;myPageTimestamp=0;if(0==vtabIndex){var o=true}if(o){if($(this).hasClass("sina_disable")){var q="<div class='bind_txt'><div class='imply_color'>查看我的微博需要绑定新浪微博帐号</div><a href='/accounts/source'>马上绑定</a></div>";$("#source_list").html(q);return false}}else{if($(this).hasClass("tencent_disable")){var q="<div class='bind_txt'><div class='imply_color'>查看我的广播需要绑定腾讯微博帐号</div><a href='/accounts/source'>马上绑定</a></div>";$("#source_list").html(q);return false}}var p,n;if(o){p=weibo_url;n={operation:"my_weibo",page:myPage}}else{p=tweibo_url;n={operation:"my_weibo",page:0,timestamp:myPageTimestamp}}$.ajax({type:"GET",url:p,data:n,beforeSend:function(){var r=$("<span class='loading_wrapper'><img src='../img/loading.gif' /></span>");$("#source_list").html(r)},success:function(r){$("#source_list").html(r);if(0==vtabIndex){show_weibo_card("source_list")}}})});$("#follow_tab").click(function(){$(".weibo_drag").remove();$(".loadmore").remove();$("#weibo_search").addClass("none");followPage=1;followTimestamp=0;if(0==vtabIndex){var o=true}if(o){if($(this).hasClass("sina_disable")){var q="<div class='bind_txt'><div class='imply_color'>查看我的关注需要绑定新浪微博帐号</div><a href='/accounts/source'>马上绑定</a></div>";$("#source_list").html(q);return false}}else{if($(this).hasClass("tencent_disable")){var q="<div class='bind_txt'><div class='imply_color'>查看我的收听需要绑定腾讯微博帐号</div><a href='/accounts/source'>马上绑定</a></div>";$("#source_list").html(q);return false}}var p,n;if(o){p=weibo_url;n={operation:"my_follow",page:followPage}}else{p=tweibo_url;n={operation:"my_follow",page:0,timestamp:followTimestamp}}$.ajax({type:"GET",url:p,data:n,beforeSend:function(){var r=$("<span class='loading_wrapper'><img src='../img/loading.gif' /></span>");$("#source_list").html(r)},success:function(r){$("#source_list").html(r);if(0==vtabIndex){show_weibo_card("source_list")}}})});$("#favorite_tab").click(function(){$(".weibo_drag").remove();$(".loadmore").remove();$("#weibo_search").addClass("none");favPage=1;favTimestamp=0;if(0==vtabIndex){var o=true}if(o){if($(this).hasClass("sina_disable")){var q="<div class='bind_txt'><div class='imply_color'>查看我的收藏需要绑定新浪微博帐号</div><a href='/accounts/source'>马上绑定</a></div>";$("#source_list").html(q);return false}}else{if($(this).hasClass("tencent_disable")){var q="<div class='bind_txt'><div class='imply_color'>查看我的收藏需要绑定腾讯微博帐号</div><a href='/accounts/source'>马上绑定</a></div>";$("#source_list").html(q);return false}}var p,n;if(o){p=weibo_url;n={operation:"my_fav",page:favPage}}else{p=tweibo_url;n={operation:"my_fav",page:0,timestamp:favTimestamp}}$.ajax({type:"GET",url:p,data:n,beforeSend:function(){var r=$("<span class='loading_wrapper'><img src='../img/loading.gif' /></span>");$("#source_list").html(r)},success:function(r){$("#source_list").html(r);if(0==vtabIndex){show_weibo_card("source_list")}}})});$("#search_tab").click(function(p){weiboSearhPage=1;tweibosearchPage=1;if($("#keywords").hasClass("imply_color")){$("#keywords").val("关键字")}$("#source_list").children().remove();if(0==vtabIndex){$("#weibo_search_btn").text("搜索话题");p.preventDefault();var o=weibo_url;var n;n={operation:"list_ht"};$.ajax({type:"GET",url:o,data:n,beforeSend:function(){var q=$("<span class='loading_wrapper'><img src='../img/loading.gif' /></span>");$("#source_list").html(q)},success:function(q){$("#source_list").html(q)}})}else{$("#weibo_search_btn").text("搜索微博")}$("#weibo_search").addClass("imply_color").removeClass("none")});$("#user_tab").click(function(){userSearchPage=1;tuserSearchPage=1;if($("#keywords").hasClass("imply_color")){$("#keywords").val("微博用户名")}$("#source_list").children().remove();$("#weibo_search_btn").text("搜索用户");$("#weibo_search").addClass("imply_color").removeClass("none")});$("#weibo_search_btn").click(function(r){r.preventDefault();weiboSearhPage=1;userSearchPage=1;tuserSearchPage=1;tweibosearchPage=1;$(".loadmore").remove();var p,n,o=true,s=$("#keywords").val(),q=$("#weibo_search_btn").text();if(q==="搜索用户"){if(0==vtabIndex){o=l;p=weibo_url;n={operation:"user_search",keywords:s,page:userSearchPage}}else{p=tweibo_url;n={operation:"list_user",keywords:s,page:tuserSearchPage}}}else{if(0==vtabIndex){o=l;p=weibo_url;n={operation:"weibo_search",keywords:s,page:weiboSearhPage}}else{o=m;p=tweibo_url;n={operation:"weibo_search",keywords:s,page:tweibosearchPage}}}$.ajax({type:"GET",url:p,data:n,beforeSend:function(){var t=$("<span class='loading_wrapper'><img src='../img/loading.gif' /></span>");$("#source_list").html(t)},success:function(t){$("#source_list").html(t);if(!o){$(".add_fav").remove()}if(0==vtabIndex){show_weibo_card("source_list")}}})});$("#douban_search_btn").click(function(r){r.preventDefault();var o=d.tabs("option","selected");var p=douban_url;var q=$("#d_keywords").val();var n;switch(o){case 0:n={operation:"book",keywords:q,startIndex:bookStartIndex,numResults:doubanItemCounts};break;case 1:n={operation:"movie",keywords:q,startIndex:movieStartIndex,numResults:doubanItemCounts};break;case 2:n={operation:"music",keywords:q,startIndex:musicStartIndex,numResults:doubanItemCounts};break;case 3:n={operation:"event",keywords:q,startIndex:eventStartIndex,numResults:doubanItemCounts};break;default:break}$.ajax({type:"GET",url:p,data:n,beforeSend:function(){var s=$("<span class='loading_wrapper'><img src='../img/loading.gif' /></span>");$("#source_list").html(s)},success:function(s){$("#source_list").html(s)}})});$("#search_tab_pic").click(function(){picSearchPage=1;$("#source_list").children().remove();$("#pic_keywords").val("关键字").addClass("imply_color")});$("#user_tab_pic").click(function(){userpicSearchPage=1;$("#source_list").children().remove();$("#pic_keywords").val("又拍用户名，注意不是昵称").addClass("imply_color")});$("#collect_tab_pic").click(function(){colSearchPage=1;$("#source_list").children().remove();$("#pic_keywords").val("又拍用户名，注意不是昵称").addClass("imply_color")});$("#recom_tab_pic").click(function(){recSearchPage=1;$("#source_list").children().remove();$("#pic_keywords").val("可指定日期如2010-6,默认搜索全部").addClass("imply_color")});$("#pic_search_btn").click(function(q){q.preventDefault();$(".loadmore").remove();var r=$("#pic_keywords").val();var p=k.tabs("option","selected");var o=yupoo_url;var n;if(0==p){n={operation:"pic_search",keywords:r,page:picSearchPage}}else{if(1==p){if($("#user_tab_pic").hasClass("yupoo_disable")){var s="<div class='bind_txt'><div class='imply_color'>用户搜索功能需要绑定又拍帐号</div><a href='/accounts/source'>马上绑定</a></div>";$("#source_list").html(s);return false}n={operation:"user_search",keywords:r,page:userpicSearchPage}}else{if(2==p){n={operation:"col_search",keywords:r,page:colSearchPage}}else{if(3==p){n={operation:"rec_search",keywords:r,page:recSearchPage}}}}}$.ajax({type:"GET",url:o,data:n,beforeSend:function(){var t=$("<span class='loading_wrapper'><img src='../img/loading.gif' /></span>");$("#source_list").html(t)},success:function(t){$("#source_list").html(t)}})});$("#source_list, #story_list").sortable({connectWith:".connectedSortable",cancel:".weibo_drop, .douban_drop, .img_upload_drop, .video_drop, .addTextElementAnchor, .textElement, .tuser, .loadmore, .ht_wrapper, .bind_txt",receive:function(T,Y){var H=Y.item;var I=("<li class='addTextElementAnchor'><span><a class='add_comment'></a></span></li>");var R=H.prev("li");var ad=H.next("li");if(!R.hasClass("addTextElementAnchor")){H.before(I)}if(!ad.hasClass("addTextElementAnchor")){H.after(I)}var P=$("#story_list li:not(.addTextElementAnchor, .textElement, .video_drop)");if(H.hasClass("weibo_drag")){var V="";var F="";var B=H.find(".user_page").attr("href");var ak=H.find(".weibo_text").html();var ac=H.find(".weibo_from").text();var D=H.find(".create_time").text();var ae=H.find(".profile_img").attr("src");var x;if(H.hasClass("sina")){if(H.find(".weibo_img img").length!=0){var y=H.find(".weibo_img img").attr("src").replace(/thumbnail/,"bmiddle");V="<div class='weibo_img_drop'><img src='"+y+"' /></div>"}if(H.find(".weibo_retweet_img img").length!=0){var ai=H.find(".weibo_retweet_img img").attr("src").replace(/thumbnail/,"bmiddle");F="<div class='weibo_retweet_img_drop'><img src='"+ai+"' /></div>"}H.removeClass("weibo_drag").addClass("weibo_drop sina").children().remove();x=("<div class='cross' action='delete'></div><div class='handle'></div><div class='story_wrapper'><div class='content_wrapper'><span class='weibo_text_drop'>"+ak+"</span>"+F+V+"</div><div class='story_signature'><span class='float_r'><a href='"+B+"' target='_blank'><img class='profile_img_drop' src='"+ae+"' alt='"+ac+"' border=0 /></a></span><div class='signature_text_drop'><div class='text_wrapper'><span><a class='weibo_from_drop' href='"+B+"' target='_blank'>"+ac+"</a></span></div><div class='weibo_date_drop'>"+D+"</div></div></div></div>");if(H.index(P)==0){$("#story_thumbnail").attr("src",ae.replace(/(\d+)\/50\/(\d+)/,"$1/180/$2"))}}else{if(H.find(".weibo_img img").length!=0){var y=H.find(".weibo_img img").attr("src").replace(/120$/,"240");V="<div class='weibo_img_drop'><img src='"+y+"' /></div>"}if(H.find(".weibo_retweet_img img").length!=0){var ai=H.find(".weibo_retweet_img img").attr("src").replace(/120$/,"240");F="<div class='weibo_retweet_img_drop'><img src='"+ai+"' /></div>"}H.removeClass("weibo_drag").addClass("weibo_drop tencent").children().remove();x=("<div class='cross' action='delete'></div><div class='handle'></div><div class='story_wrapper'><div class='content_wrapper'><span class='weibo_text_drop'>"+ak+"</span>"+F+V+"</div><div class='story_signature'><span class='float_r'><a href='"+B+"' target='_blank'><img class='profile_img_drop' src='"+ae+"' alt='"+ac+"' border=0 /></a></span><div class='signature_text_drop'><div class='text_wrapper'><span ><a class='weibo_from_drop' href='"+B+"' target='_blank'>"+ac+"</a></span></div><div class='weibo_date_drop'>"+D+"</div></div></div></div>");if(H.index(P)==0){$("#story_thumbnail").attr("src",ae.replace(/50$/,"180"))}}H.append(x);if(0==vtabIndex){show_weibo_card(H.attr("id"))}}else{if(H.hasClass("douban_drag")){var K="",s=H.find(".profile_img").attr("src"),J=H.find(".profile_img").attr("title"),o=H.find(".douban_from").attr("href");if(H.hasClass("event")){var u=H.find(".event_title a").text(),p=H.find(".event_summary").text(),al=H.find(".event_initiator a").text(),t=H.find(".event_initiator a").attr("href"),ah=H.find(".start_time").text(),n=H.find(".end_time").text(),M=H.find(".event_title a").attr("href"),A=H.find(".event_img_wrapper img").attr("src"),aa=H.find(".event_location").text(),X=H.find(".event_city").text();K=("<div class='cross' action='delete'></div><div class='handle'></div><div class='douban_wrapper'><div class='content_wrapper'><div class='event_summary_drop'>"+p+"</div><div class='event_wrapper'><a href='"+M+"' target='_blank'><img class='item_img_drop float_l' src='"+A+"' /></a><div class='item_meta_drop'><div class='event_title_drop'>活动：<a href='"+M+"' target='_blank'>"+u+"</a></div><div class='event_initiator_drop'>发起人：<a href='"+t+"' target='_blank'>"+al+"</a></div><div class='start_time_drop'>"+ah+"</div><div class='end_time_drop'>"+n+"</div><div class='event_city_drop'>"+X+"</div><div class='event_location_drop'>"+aa+"</div></div></div></div><div class='douban_signature'><span class='float_r'><a href='"+o+"' target='_blank'><img class='profile_img_drop' src='"+s+"' alt='"+J+"' border=0 /></a></span><span class='signature_text_drop'><div class='text_wrapper'><span ><a class='douban_from_drop' href='"+o+"' target='_blank'>"+J+"</a></span></div><div class='douban_date_drop'></div></span> </div></div>");H.removeClass("douban_drag").addClass("douban_drop").children().remove();if(H.index(P)==0){$("#story_thumbnail").attr("src",s)}H.append(K)}else{if(H.hasClass("bookReviews")||H.hasClass("movieReviews")||H.hasClass("musicReviews")){var E=H.find(".item_title").attr("href"),w=H.find(".comment_title").text(),an=H.find(".comment_summary").html(),Z=H.find(".comment_date").text(),U=H.find(".item_img").attr("src"),C=H.find(".item_title").text(),W=H.find(".item_author").text(),z=H.find(".item_date").text(),ap=H.find(".average_rating").text(),v=H.find(".item_rating").text();K=("<div class='cross' action='delete'></div><div class='handle'></div><div class='douban_wrapper'><div class='content_wrapper'><div><div class='comment_title_drop'>"+w+"</div><div class='comment_summary_drop'>"+an+"</div></div><div class='item_info_drop'><a href='"+E+"' target='_blank'><img class='item_img_drop float_l' src='"+U+"' /></a><div class='item_meta_drop'><div><a class='item_title_drop' href='"+E+"' target='_blank'>"+C+"</a></div><div class='item_author_drop'>"+W+"</div><div class='item_date_drop'>"+z+"</div><div class=item_rating_drop>"+v+"</div><div class='average_rating_drop'>"+ap+"</div></div></div></div><div class='douban_signature'><span class='float_r'><a href='"+o+"' target='_blank'><img class='profile_img_drop' src='"+s+"' alt='"+J+"' border=0 /></a></span><span class='signature_text_drop'><div class='text_wrapper'><span ><a class='douban_from_drop' href='"+o+"' target='_blank'>"+J+"</a></span></div><div class='douban_date_drop'>"+Z+"</div></span> </div></div>");H.removeClass("douban_drag").addClass("douban_drop").children().remove();if(H.index(P)==0){$("#story_thumbnail").attr("src",s)}H.append(K)}else{if(H.index(P)==0){$("#story_thumbnail").attr("src",H.find(".item_img").attr("src"))}H.removeClass("douban_drag").addClass("douban_drop");H.find(".douban_flag").removeClass().addClass("content_wrapper");H.find(".douban_review").closest("div").remove();H.prepend("<div class='cross' action='delete'></div><div class='handle'></div>")}}}else{if(H.hasClass("img_upload_drag")){var ab=H.find("img").attr("src"),N=("<div class='cross' action='delete'></div><div class='handle'></div><div class='img_wrapper'><img src='"+ab+"'></div>");if(H.index(P)==0){$("#story_thumbnail").attr("src",H.find("img").attr("src"))}H.removeClass("img_upload_drag").addClass("img_upload_drop").children().remove();H.append(N)}else{if(H.hasClass("video_drag")){var am=H.find(".videoTitle a"),ag=am.attr("href"),ao=am.text();var q=("<div class='cross' action='delete'></div><div class='handle'></div><div class='youku_wrapper'><div><a class='videoTitle' target='_blank' href='"+ag+"'>"+ao+"</a></div><div class='embed'>"+embedCode+"</div></div>");H.removeClass("video_drag").addClass("video_drop").children().remove();H.append(q)}else{if(H.hasClass("pic_drag")){var Q=H.find("img").attr("src"),O=H.find(".pic_title").text(),G=H.find(".pic_title").attr("href"),af=H.find(".pic_author").text(),L=H.find(".pic_author").attr("href"),r=Q.split("/"),S=r.length;r[S-1]="small";Q=r.join("/");var aj=("<div class='cross' action='delete'></div><div class='handle'></div><div class='yupoo_wrapper'><a target='_blank' href='"+G+"'><img class='pic_img' src='"+Q+"'/></a><div><a class='pic_title' target='_blank' href='"+G+"'>"+O+"</a></div><div><a class='pic_author' target='_blank' href='"+L+"'>"+af+"</a></div><div class='yupoo_sign'></div></div>");H.removeClass("pic_drag").addClass("pic_drop").children().remove();H.append(aj);if(H.index(P)==0){$("#story_thumbnail").attr("src",Q.replace(/small$/,"square"))}}}}}}}});$("#embedVideo").click(function(r){r.preventDefault();var n=$("<span class='loading_wrapper'><img src='../img/loading.gif' /></span>");$("#source_list").html(n);var v,w="<div class='bind_txt'><div class='imply_color center'>请检查输入的视频链接是否可以正常访问或再试一次</div></div>",o=$("#videoUrl"),u=o.val(),p={url:u},s="/member/embedVideo.php",q=new RegExp("youku.com/|tudou.com/"),t=q.test(u);if(o.hasClass("imply_color")||!t){v=w;$("#source_list").html(v);return false}$.get(s,p,function(z,C){if(C=="success"){if(z.errorcode==0){embedCode=z.embedcode;var A=z.title,x=z.desc,y=z.host+".com",B=z.img;if(typeof x==="undefined"){x=""}v="<li class='video_drag'><div class='cross'></div><div class='videoTitle'><a target='_blank' href='"+u+"'>"+A+"</a></div><div class='videoContent'><img class='video_thumbnail' src='"+B+"' /><div class='video_wrapper'><div class='video_domain'><a target='_blank' href='"+u+"'>"+y+"</a></div><div class='video_description'>"+x+"</div></div></div></li>"}else{v=w}$("#source_list").html(v);o.addClass("imply_color").val("请输入视频播放页地址")}},"json")});var a=$("#sto_title"),c=$("#sto_summary"),g=$("#sto_tag");if(a.val()==""){a.focus()}a.focus(function(){if(a.hasClass("imply_flag")){a.val("").removeClass("imply_flag")}}).blur(function(){if(a.val()==""){a.addClass("imply_flag").val("你的故事标题")}});if(c.val()==""){c.val(sum_txt).addClass("imply_color")}c.focus(function(){if(c.hasClass("imply_color")){c.val("").removeClass("imply_color")}}).blur(function(){if(c.val()==""){c.val(sum_txt).addClass("imply_color")}});if(g.val()==""){g.val(tags_txt).addClass("imply_color")}g.focus(function(){if(g.hasClass("imply_color")){g.val("").removeClass("imply_color")}}).blur(function(){if(g.val()==""){g.val(tags_txt).addClass("imply_color")}});$("#story_list li").live("mouseover",function(n){$(this).find(".cross").css("visibility","visible")});$("#story_list li").live("mouseout",function(n){$(this).find(".cross").css("visibility","hidden")});$("#actions").click(function(u){u.preventDefault();var z=$(this);if(z.data("executing")){return}z.data("executing",true);var v=$(u.target);unbindonbeforeunload();if(v.hasClass("disable")){z.removeData("executing");var q=$(window).height(),x=$(window).width(),o=$(document).scrollTop(),p=$(document).scrollLeft(),w=$("#boxes #dialog");w.css("top",q/2-w.height()/2+o-100);w.css("left",x/2-w.width()/2+p);w.fadeIn(1000)}else{var y,t="/member/publish.php";if(v.is("#publishBtn")){y=prepare_story_data("Publish")}else{if(v.is("#previewBtn")){y=prepare_story_data("Preview")}else{if(v.is("#draftBtn")){y=prepare_story_data("Draft")}else{var n=confirm("确定放弃吗? 您本次做的更改不会保存。");if(n==true){if(v.hasClass("login_flag")){var s=v.closest("span").attr("id").substr(5);self.location="/user/"+s;return false}else{self.location="/";return false}}else{z.removeData("executing");return false}}}}if(v.is("#publishBtn")&&$("#sto_title").hasClass("imply_flag")){z.removeData("executing");alert("请为你的故事输入一个标题");$("#sto_title").focus()}else{$.post(t,y,function(r,A){self.location=r})}}});$(".douban_review").live("click",function(p){p.preventDefault();var o=douban_rurl;var n;var q=$(this).closest(".douban_drag").attr("id").substr(2);if($(this).hasClass("book")){n={operation:"bookReviews",subjectID:q,startIndex:bookReviewStartIndex,numResults:commentsPerQuery}}else{if($(this).hasClass("movie")){n={operation:"movieReviews",subjectID:q,startIndex:movieReviewStartIndex,numResults:commentsPerQuery}}else{if($(this).hasClass("music")){n={operation:"musicReviews",subjectID:q,startIndex:musicReviewStartIndex,numResults:commentsPerQuery}}}}$.ajax({type:"GET",url:o,data:n,beforeSend:function(){var r=$("<span class='loading_wrapper'><img src='../img/loading.gif' /></span>");$("#source_list").html(r)},success:function(r){$("#source_list").html(r)}})});$(".list_tweibo").live("click",function(q){usersearchTimestamp=0;q.preventDefault();var o=tweibo_url,p=$(this).closest(".weibo_drag").attr("id"),n={operation:"user_search",keywords:p,page:0,timestamp:usersearchTimestamp};$.ajax({type:"GET",url:o,data:n,beforeSend:function(){var r=$("<span class='loading_wrapper'><img src='../img/loading.gif' /></span>");$("#source_list").html(r)},success:function(r){$("#source_list").html(r);if(!m){$(".add_fav").remove()}}})});$(".list_t_weibo").live("click",function(p){p.preventDefault();weiboSearhPage=1;var o=weibo_url,n,q=$(this).text();$("#keywords").removeClass("imply_color").val(q);n={operation:"weibo_search",keywords:q,page:weiboSearhPage};$.ajax({type:"GET",url:o,data:n,beforeSend:function(){var r=$("<span class='loading_wrapper'><img src='../img/loading.gif' /></span>");$("#source_list").html(r)},success:function(r){$("#source_list").html(r);if(!l){$(".add_fav").remove()}show_weibo_card("source_list")}})});$("#source_list").click(function(t){var r,p=true;if(0==vtabIndex||1==vtabIndex){r=h.tabs("option","selected")}else{if(4==vtabIndex){r=d.tabs("option","selected")}else{if(5==vtabIndex){r=k.tabs("option","selected")}}}if($(t.target).is(".loadmore")){var q,n;if(0==r){var u;if(0==vtabIndex){p=l;u=$("#keywords").val();q=weibo_url;weiboSearhPage++;n={operation:"weibo_search",keywords:u,page:weiboSearhPage}}else{if(1==vtabIndex){p=m;u=$("#keywords").val();q=tweibo_url;tweibosearchPage++;n={operation:"weibo_search",keywords:u,page:tweibosearchPage}}else{if(4==vtabIndex){var o=$(".loadmore");if(o.hasClass("book")){q=douban_url;bookStartIndex=bookStartIndex+doubanItemCounts;n={operation:"book",keywords:$("#d_keywords").val(),startIndex:bookStartIndex,numResults:doubanItemCounts}}else{if(o.hasClass("bookReviews")){q=douban_rurl;bookReviewStartIndex=bookReviewStartIndex+commentsPerQuery;n={operation:"bookReviews",subjectID:o.attr("id"),startIndex:bookReviewStartIndex,numResults:commentsPerQuery}}}}else{if(5==vtabIndex){u=$("#pic_keywords").val();q=yupoo_url;picSearchPage++;n={operation:"pic_search",keywords:u,page:picSearchPage}}}}}$(".loadmore").remove();$.get(q,n,function(v,w){$("#source_list").append(v);if(!p){$(".add_fav").remove()}if(0==vtabIndex){show_weibo_card("source_list")}})}else{if(1==r){if(0==vtabIndex){p=l;q=weibo_url;userSearchPage++;n={operation:"user_search",keywords:$("#keywords").val(),page:userSearchPage}}else{if(1==vtabIndex){p=m;q=tweibo_url;if($(t.target).closest(".loadmore").hasClass("tuser")){tuserSearchPage++;n={operation:"list_user",keywords:$("#keywords").val(),page:tuserSearchPage}}else{var s=$(".loadmore").prev().find(".user_page").attr("href").replace(/http:\/\/t.qq.com\//,"");usersearchTimestamp=$(".loadmore span").attr("id");n={operation:"user_search",keywords:s,page:1,timestamp:usersearchTimestamp}}}else{if(4==vtabIndex){var o=$(".loadmore");if(o.hasClass("movie")){q=douban_url;movieStartIndex=movieStartIndex+doubanItemCounts;n={operation:"movie",keywords:$("#d_keywords").val(),startIndex:movieStartIndex,numResults:doubanItemCounts}}else{if(o.hasClass("movieReviews")){q=douban_rurl;movieReviewStartIndex=movieReviewStartIndex+commentsPerQuery;n={operation:"movieReviews",subjectID:o.attr("id"),startIndex:movieReviewStartIndex,numResults:commentsPerQuery}}}}else{if(5==vtabIndex){u=$("#pic_keywords").val();q=yupoo_url;userpicSearchPage++;n={operation:"user_search",keywords:u,page:userpicSearchPage}}}}}$(".loadmore").remove();$.get(q,n,function(v,w){$("#source_list").append(v);if(!p){$(".add_fav").remove()}if(0==vtabIndex){show_weibo_card("source_list")}})}else{if(2==r){if(0==vtabIndex){q=weibo_url;myPage++;n={operation:"my_weibo",page:myPage}}else{if(1==vtabIndex){q=tweibo_url;myPageTimestamp=$(".loadmore span").attr("id");n={operation:"my_weibo",page:1,timestamp:myPageTimestamp}}else{if(4==vtabIndex){var o=$(".loadmore");if(o.hasClass("music")){q=douban_url;musicStartIndex=musicStartIndex+doubanItemCounts;n={operation:"music",keywords:$("#d_keywords").val(),startIndex:musicStartIndex,numResults:doubanItemCounts}}else{if(o.hasClass("musicReviews")){q=douban_rurl;musicReviewStartIndex=musicReviewStartIndex+commentsPerQuery;n={operation:"musicReviews",subjectID:o.attr("id"),startIndex:musicReviewStartIndex,numResults:commentsPerQuery}}}}else{if(5==vtabIndex){u=$("#pic_keywords").val();q=yupoo_url;colSearchPage++;n={operation:"col_search",keywords:u,page:colSearchPage}}}}}$(".loadmore").remove();$.get(q,n,function(v,w){$("#source_list").append(v);if(0==vtabIndex){show_weibo_card("source_list")}})}else{if(3==r){if(0==vtabIndex){q=weibo_url;followPage++;n={operation:"my_follow",page:followPage}}else{if(1==vtabIndex){q=tweibo_url;followTimestamp=$(".loadmore span").attr("id");n={operation:"my_follow",page:1,timestamp:followTimestamp}}else{if(4==vtabIndex){q=douban_url;eventStartIndex=eventStartIndex+doubanItemCounts;n={operation:"event",keywords:$("#d_keywords").val(),startIndex:eventStartIndex,numResults:doubanItemCounts}}else{if(5==vtabIndex){u=$("#pic_keywords").val();q=yupoo_url;recSearchPage++;n={operation:"rec_search",keywords:u,page:recSearchPage}}}}}$(".loadmore").remove();$.get(q,n,function(v,w){$("#source_list").append(v);if(0==vtabIndex){show_weibo_card("source_list")}})}else{if(0==vtabIndex){q=weibo_url;favPage++;n={operation:"my_fav",page:favPage}}else{if(1==vtabIndex){q=tweibo_url;favTimestamp=$(".loadmore span").attr("id");n={operation:"my_fav",page:1,timestamp:favTimestamp}}}$(".loadmore").remove();$.get(q,n,function(v,w){$("#source_list").append(v);if(0==vtabIndex){show_weibo_card("source_list")}})}}}}}});$(".addTextElementAnchor").live("mouseenter",function(){$(this).css("background-color","#FDFFD2").append('<span class="add_text">点击添加文字</span>')}).live("mouseleave",function(){$(this).css("background-color","#FFFFFF").find(".add_text").remove()});$("#story_list").click(function(r){if($(r.target).is(".add_comment")||$(r.target).is(".add_text")||$(r.target).is(".addTextElementAnchor")){r.preventDefault();var o=$("<li class='textElement editing'><div class='editingDiv'><form class='formTextElement'><textarea class='inputEditor' name='inputEditor'></textarea></form><div class='belowTextEdit'><div class='actions'><button class='submit submitComment' type='submit'>确定</button><button class='cancel cancelEditor' type='reset'>取消</button></div></div></div></li><li class='addTextElementAnchor'><span><a class='add_comment'></a></span></li>");$(r.target).closest("li").after(o);$(".inputEditor").cleditor({width:476,height:150,controls:"bold italic underline strikethrough | font size removeformat | bullets numbering | alignleft center alignright | undo redo | link unlink"})}if($(r.target).is(".cancelEditor")){r.preventDefault();$(r.target).closest(".textElement").next(".addTextElementAnchor").remove();$(r.target).closest(".textElement").remove()}if($(r.target).is(".submitComment")){r.preventDefault();var q=$(r.target).closest(".textElement"),s=q.find(".inputEditor").val(),n=s.replace(/(\&nbsp;|\<br\>)/g,"");n=$.trim(n);if(n==""){$(r.target).closest(".textElement").next(".addTextElementAnchor").remove();$(r.target).closest(".textElement").remove()}else{$(r.target).closest(".editingDiv").remove();var p=$("<div class='cross' action='delete'></div><div class='handle'></div><div class='commentBox'>"+s+"</div>");q.removeClass("editing").addClass("editted").append(p)}}});$(".add_fav").live("click",function(q){q.preventDefault();var p=$(this),r=p.closest("li"),o=r.attr("id").substr(2),n={operation:"add_fav",id:o};if(r.hasClass("sina")){postUrl="/weibo/postweibo.php"}else{postUrl="/tweibo/posttweibo.php"}$.post(postUrl,n,function(s,t){if(t=="success"){p.text("[取消收藏]");p.removeClass().addClass("del_fav")}})});$(".del_fav").live("click",function(q){q.preventDefault();var p=$(this),r=p.closest("li"),o=r.attr("id").substr(2),n={operation:"del_fav",id:o};if(r.hasClass("sina")){postUrl="/weibo/postweibo.php"}else{postUrl="/tweibo/posttweibo.php"}$.post(postUrl,n,function(s,t){if(t=="success"){if(p.hasClass("remove_flag")){r.hide("slow",function(){r.remove()})}else{p.text("[收藏]");p.removeClass().addClass("add_fav")}}})});var e=$("#upload_btn"),b;if(e.length){new AjaxUpload(e,{action:"/member/imgupload.php",name:"photofile",onSubmit:function(n,o){o=o.toLowerCase();if(o&&/^(jpg|png|jpeg|gif|bmp)$/.test(o)){e.text("正在上传");this.disable();b=window.setInterval(function(){var p=e.text();if(p.length<13){e.text(p+".")}else{e.text("正在上传")}},200)}else{$('<div class="bind_txt"><div class="imply_color">不支持该文件类型</div></div>').appendTo("#source_list");return false}},onComplete:function(o,n){e.text("添加照片");window.clearInterval(b);this.enable();$("#source_list .imply_color").remove();$("#source_list").append(n)}})}var f=$("#vtab>ul>li");var i=0;f.click(function(){f.removeClass("selected");$(this).addClass("selected");vtabIndex=f.index($(this));switch(vtabIndex){case 0:$("#search_tab").text("话题搜索");$("#my_tab").text("我的微博");$("#follow_tab").text("我的关注");$("#weibo_search_btn").text("搜索话题");if(0!=i){h.tabs("select",0);$("#weibo_search").removeClass("none");$("#source_list").children().remove();if($("#keywords").hasClass("imply_color")){$("#keywords").val("关键字")}var o=weibo_url;var n;n={operation:"list_ht"};$.ajax({type:"GET",url:o,data:n,beforeSend:function(){var p=$("<span class='loading_wrapper'><img src='../img/loading.gif' /></span>");$("#source_list").html(p)},success:function(p){$("#source_list").html(p)}})}i=0;$("#vtab>div").hide().eq(vtabIndex).show();break;case 1:$("#search_tab").text("微博搜索");$("#my_tab").text("我的广播");$("#follow_tab").text("我的收听");$("#weibo_search_btn").text("搜索微博");if(1!=i){h.tabs("select",0);$("#weibo_search").removeClass("none");$("#source_list").children().remove();if($("#keywords").hasClass("imply_color")){$("#keywords").val("关键字")}}i=1;$("#vtab>div").hide().eq(vtabIndex-1).show();break;case 2:if(2!=i){$("#source_list").children().remove()}i=2;$("#vtab>div").hide().eq(vtabIndex-1).show();break;case 3:if(3!=i){$("#source_list").children().remove()}i=3;$("#vtab>div").hide().eq(vtabIndex-1).show();break;case 4:if(4!=i){d.tabs("select",0);$("#source_list").children().remove();if($("#d_keywords").hasClass("imply_color")){$("#d_keywords").val("书名")}}i=4;$("#vtab>div").hide().eq(vtabIndex-1).show();break;case 5:if(5!=i){k.tabs("select",0);$("#source_list").children().remove();$("#pic_keywords").val("关键字").addClass("imply_color")}i=5;$("#vtab>div").hide().eq(vtabIndex-1).show();break}}).eq(0).click();$(".window .close").click(function(n){n.preventDefault();$("#mask").hide();$(".window").hide()});$("#mask").click(function(){$(this).hide();$(".window").hide()})});