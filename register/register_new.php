<?php  // include function files for this application  include "../global.php";  require_once('../include/class.phpmailer.php');  //create short variable names  $email=$_POST['email'];  $username=$_POST['username'];  $passwd=$_POST['passwd'];  $invite_code=$_POST['invite_code'];  // start session which may be needed later  // start it now because it must go before headers  session_start();  try   {    // check forms filled in    /*if (!filled_out($_POST)) {      throw new Exception('You have not filled the form out correctly - please go back and try again.');    }*/    // attempt to register    // this function can also throw an exception    	//Pay attention!register($email, $passwd, $username);	$result = $DB->query("select * from ".$db_prefix."user where email='".$email."'");	if(!$result)	{	  throw new Exception('Could not execute query.');	}    if ($DB->num_rows($result)>0)	{      throw new Exception('That email is taken - go back and choose another one.');    }    // if ok, put in db    //$result = $DB->query("insert into ".$db_prefix."user values                         //(null, '".$username."', sha1('".$password."'), '".$email."', 0)");    //if (!$result) {      //throw new Exception('Could not register you in database - please try again later.');    //}		  $url = 'http://'.$_SERVER['SERVER_NAME'].dirname($_SERVER['SCRIPT_NAME']).'/activation.php';	  $url .= '?username='.urlencode($username);	  $mail = new PHPMailer();	  $mail->CharSet = "gb2312";	  $mail->ishtml(true);	  $body = '<p>欢迎您在StoryBing注册用户，请点击以下链接以激活您的帐户:<br/><br/>	(pleae click on the following link to activate your account:)<br/><br/>	<a href="'.$url.'" target="_blank">'.$url.'</a><br/><br/>	如果您的email程序不支持链接点击，请将上面的地址拷贝至您的浏览器(例如IE)的地址栏进入StoryBing。<br/><br/>	感谢您对StoryBing的支持，希望您在StoryBing的体验有益和愉快。<br/><br/>	StoryBing http://www.storybing.com<br/><br/>	(这是一封自动产生的email，请勿回复。)</p>';	  $mail->IsSMTP(); // telling the class to use SMTP	  $mail->Host       = "localhost"; // SMTP server	  //$mail->SMTPDebug  = 2;                     // enables SMTP debug information (for testing)											   // 1 = errors and messages											   // 2 = messages only	  $mail->SMTPAuth   = true;                  // enable SMTP authentication	  $mail->SMTPSecure = "ssl";                 // sets the prefix to the servier	  //$mail->Host       = "smtp.gmail.com";      // sets GMAIL as the SMTP server	  $mail->Host       = "smtp.qq.com";      // sets GMAIL as the SMTP server	  $mail->Port       = 465;                   // set the SMTP port for the GMAIL server	  //$mail->Username   = "xinxinzhang22@gmail.com";  // GMAIL username	  //$mail->Password   = "kooky233";            // GMAIL password	  $mail->Username   = "11473124@qq.com";  // qq username	  $mail->Password   = "kenzo22";            // qq password	  $mail->SetFrom('11473124@qq.com', 'StoryBing');	  $mail->AddReplyTo("kenzo@storybing.com","StoryBing");	  $mail->Subject    = "StoryBing注册用户激活邮件";	  $mail->AltBody    = "To view the message, please use an HTML compatible email viewer!"; // optional, comment out and test	  $mail->MsgHTML($body);	  $address = "11473124@qq.com";	  $mail->AddAddress($address, "kooky_233");	  if(!$mail->Send()) {		echo "Mailer Error: " . $mail->ErrorInfo;	  } else {		//echo "Message sent!";		$result = $DB->query("insert into ".$db_prefix."user values                         (null, '".$username."', sha1('".$password."'), '".$email."', 0)");		$content="<div class='div_center' > <span class='title'> 激活帐号 </span></div> 		<div class='div_center'><span>请到 ".$email." 查阅来自StoryBing的邮件, 从邮件激活你的密码。<span></div>		<div class='div_center'><a target='_blank' href='http://mail.google.com'><span>登录Gmail邮箱查收激活确认信</span></a> </div>";		echo $content;		if (!$result) {          throw new Exception('Could not register you in database - please try again later.');        }	  }	    // register session variable    $_SESSION['valid_user'] = $username;    // provide link to members page    //echo 'Your registration was successful.  Go to the members page to start setting up your bookmarks!';    //do_html_url('member.php', 'Go to members page');   // end page  }  catch (Exception $e) {     //do_html_header('Problem:');     echo $e->getMessage();     //do_html_footer();     exit;  }    include "../include/footer.htm";?>